<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Æ‡¶°‡¶æ‡¶∞‡ßá‡¶ü‡¶∞: ‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â</title>
    <script src="https://cdn.tailwindcss.com"> </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ‡¶´‡¶®‡ßç‡¶ü ‡¶ì ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® */
        body {
            font-family: 'Hind Siliguri', Inter, sans-serif;
            background-color: #f7f9fc;
            min-height: 100vh;
        }

        /* ‡¶¨‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ - ‡¶Ü‡¶ß‡ßÅ‡¶®‡¶ø‡¶ï ‡¶®‡ßÄ‡¶≤ */
        .brand-blue {
            background-color: #0d6efd;
            transition: background-color 0.2s;
        }

        .brand-blue:hover {
            background-color: #0b5ed7;
        }

        .brand-blue-text {
            color: #0d6efd;
        }

        /* ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ - ‡¶è‡¶≤‡¶ø‡¶≠‡ßá‡¶ü‡ßá‡¶° ‡¶≤‡ßÅ‡¶ï */
        .app-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
            transition: box-shadow 0.3s, transform 0.2s;
        }

        .app-card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }
        
        /* ‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .proof-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            transition: background-color 0.3s;
        }

        .proof-card:hover {
            background-color: #fcfcfc;
        }

        /* ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶õ‡¶¨‡¶ø‡¶∞ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .profile-photo-container {
            position: relative;
            width: 40px;
            height: 40px;
            flex-shrink: 0;
        }

        /* ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶õ‡¶¨‡¶ø‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .profile-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        /* ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡ßç‡¶≤‡ßá‡¶∏‡¶π‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .avatar-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #a5b4fc; /* Lavender blue */
            color: white;
            font-size: 18px;
            font-weight: bold;
            flex-shrink: 0;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        /* ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á‡¶° ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ (Profile.html ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡ßá‡¶ì‡¶Ø‡¶º‡¶æ) */
        .verified-badge {
            position: absolute;
            bottom: -2px; /* ‡¶õ‡¶¨‡¶ø ‡¶•‡ßá‡¶ï‡ßá ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶®‡¶ø‡¶ö‡ßá */
            right: -2px; /* ‡¶õ‡¶¨‡¶ø ‡¶•‡ßá‡¶ï‡ßá ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶°‡¶æ‡¶®‡ßá */
            background-color: #1877F2; /* ‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï ‡¶¨‡ßç‡¶≤‡ßÅ */
            color: white; /* ‡¶∏‡¶æ‡¶¶‡¶æ ‡¶ö‡ßá‡¶ï-‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï */
            border-radius: 50%;
            width: 16px; /* ‡¶õ‡ßã‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶Æ‡¶°‡¶æ‡¶∞‡ßá‡¶ü‡¶∞ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px; 
            font-weight: bold;
            border: 2px solid white; /* ‡¶®‡ßÄ‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú‡¶ü‡¶ø‡¶ï‡ßá ‡¶ò‡¶ø‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶æ‡¶¶‡¶æ ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶ï */
            box-shadow: 0 0 3px rgba(0,0,0,0.2);
        }
        
        .verified-badge .fa-check { 
            line-height: 1;
        }
        
        /* ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .custom-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            transition: opacity 0.3s ease;
        }
        
        .custom-modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 450px; /* ‡¶Æ‡¶°‡¶æ‡¶≤‡ßá‡¶∞ ‡¶∏‡¶æ‡¶á‡¶ú ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶¨‡¶æ‡¶°‡¶º‡¶æ‡¶®‡ßã ‡¶π‡¶≤‡ßã */
            text-align: center;
            animation: zoomIn 0.3s ease-out;
        }
        
        .custom-modal-actions {
            margin-top: 1.5rem;
            display: flex;
            justify-content: space-around;
            gap: 1rem;
        }
        
        .custom-modal-btn {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 9999px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center justify-center">

    <div class="container max-w-6xl mx-auto">
        <header class="app-card p-6 text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 flex items-center justify-center gap-4">
                <i class="fas fa-user-shield text-indigo-500"></i>
                ‡¶Æ‡¶°‡¶æ‡¶∞‡ßá‡¶ü‡¶∞ ‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤
            </h1>
            <p class="text-gray-500 font-semibold mt-2">‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡¶§ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßÅ‡¶´</p>
        </header>
        
        <div class="app-card p-6">
            <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center border-b pb-4">
                ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶≤‡ßã‡¶ö‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡ßÅ‡¶´
            </h2>
            <div id="proofs-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <div class="col-span-full text-center py-12 text-gray-500 text-lg" id="loading-indicator">
                    <i class="fas fa-spinner fa-spin mr-2"></i> ‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
                </div>
            </div>
        </div>
        
        <div class="mt-8 text-center">
            <a href="index.html" class="inline-flex items-center bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-full shadow-lg hover:shadow-xl transition-all duration-300">
                <i class="fas fa-arrow-left mr-2"></i>
                ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®
            </a>
        </div>
    </div>
    
    <!-- ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∂‡¶® ‡¶Æ‡¶°‡¶æ‡¶≤ -->
    <div id="moderator-modal" class="custom-modal">
        <div class="custom-modal-content">
            <h3 class="text-xl font-bold mb-2 text-gray-800" id="modal-title">‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
            <p class="text-gray-600 mb-4" id="modal-message"></p>
            
            <!-- üî• ‡¶®‡¶§‡ßÅ‡¶®: ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü (‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü‡¶∞‡ßÇ‡¶™‡ßá ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã) -->
            <div id="rejection-reason-group" class="mb-4 hidden text-left">
                <label for="rejection-reason" class="block text-sm font-medium text-gray-700 mb-2">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ (‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï):</label>
                <textarea id="rejection-reason" rows="3" class="w-full p-3 border border-red-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="‡¶ï‡ßá‡¶® ‡¶™‡ßç‡¶∞‡ßÅ‡¶´‡¶ü‡¶ø ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶§‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>
            </div>
            
            <div class="custom-modal-actions">
                <button class="custom-modal-btn bg-green-500 text-white hover:bg-green-600" id="modal-confirm-btn">
                    ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
                <button class="custom-modal-btn bg-gray-200 text-gray-800 hover:bg-gray-300" onclick="closeModeratorModal()">
                    ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
                </button>
            </div>
        </div>
    </div>
    
    <div id="notification-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
    
    <script type="module">
        // Firebase imports from rtdb-config.js
        import { auth, rtdb, showNotification, ref, onValue, update, get, runTransaction } from './rtdb-config.js'; 
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        
        // üî• ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶®‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶ü: ‡¶∏‡¶æ‡¶∏‡¶™‡ßá‡¶®‡¶∂‡¶® ‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ
        const REJECT_trust_CHANGE = -10;
        const GENERIC_WARNING = "‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶®‡¶æ ‡¶π‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§";
        
        // ‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶Æ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá, ‡¶Ø‡¶æ‡¶§‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶π‡¶ø‡¶ü‡¶ü‡¶ø‡¶á ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡¶∏‡¶æ‡¶∏‡¶™‡ßá‡¶®‡¶∂‡¶® ‡¶∏‡¶Æ‡ßü ‡¶¶‡ßá‡ßü‡•§
        const SUSPENSION_RULES = [
            { score: 40, durationMs: 24 * 60 * 60 * 1000, durationText: "‡ß®‡ß™ ‡¶ò‡¶®‡ßç‡¶ü‡¶æ" },
            { score: 50, durationMs: 3 * 60 * 60 * 1000, durationText: "‡ß© ‡¶ò‡¶®‡ßç‡¶ü‡¶æ" },
            { score: 60, durationMs: 60 * 60 * 1000, durationText: "‡ßß ‡¶ò‡¶®‡ßç‡¶ü‡¶æ" },
            { score: 70, durationMs: 30 * 60 * 1000, durationText: "‡ß©‡ß¶ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü" }
        ];

        
        const proofsGrid = document.getElementById('proofs-grid');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        const moderatorModal = document.getElementById('moderator-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        
        // üî• ‡¶®‡¶§‡ßÅ‡¶® DOM ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏
        const rejectionReasonGroup = document.getElementById('rejection-reason-group');
        const rejectionReasonInput = document.getElementById('rejection-reason');

        let currentUserId = null;
        let pendingAction = { actionType: null, data: null };
        let allUsersData = {}; 
        
        // Modal functions
        window.closeModeratorModal = () => {
            moderatorModal.style.display = 'none';
            pendingAction = { actionType: null, data: null }; // ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü
            rejectionReasonInput.value = ''; // üî• ‡¶®‡¶§‡ßÅ‡¶®: ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
        };
        
        const openModeratorModal = (type, data) => {
            pendingAction.actionType = type;
            pendingAction.data = data;
            
            let titleText = '‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®';
            let messageText = '';
            let confirmClass = '';
            
            if (type === 'approveProof') {
                titleText = '‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶¶‡¶ø‡¶®';
                messageText = `‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶™‡ßç‡¶∞‡ßÅ‡¶´‡¶ü‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ï‡ßá ${(data.points).toLocaleString('bn-BD')} ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶¶‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`;
                confirmClass = 'bg-green-500 hover:bg-green-600';
                rejectionReasonGroup.classList.add('hidden'); // üî• ‡¶®‡¶§‡ßÅ‡¶®: ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã
                modalConfirmBtn.classList.remove('bg-red-500'); // ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ
                modalConfirmBtn.classList.add('bg-green-500');
            } else if (type === 'rejectProof') {
                titleText = '‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®';
                messageText = `‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶™‡ßç‡¶∞‡ßÅ‡¶´‡¶ü‡¶ø ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®? ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§ ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶â‡¶≤‡ßç‡¶≤‡ßá‡¶ñ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`;
                confirmClass = 'bg-red-500 hover:bg-red-600';
                rejectionReasonGroup.classList.remove('hidden'); // üî• ‡¶®‡¶§‡ßÅ‡¶®: ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
                rejectionReasonInput.value = ''; // ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
                modalConfirmBtn.classList.remove('bg-green-500'); // ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ
                modalConfirmBtn.classList.add('bg-red-500');
            }

            modalTitle.textContent = titleText;
            modalMessage.textContent = messageText;
            modalConfirmBtn.className = `custom-modal-btn text-white font-bold ${confirmClass}`;
            moderatorModal.style.display = 'flex';
        };

        // ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞
        modalConfirmBtn.onclick = () => {
            const { actionType, data } = pendingAction;
            
            if (!currentUserId) {
                showNotification('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡¶°‡¶æ‡¶∞‡ßá‡¶ü‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error');
                return;
            }

            if (actionType === 'rejectProof') {
                 const rejectionReason = rejectionReasonInput.value.trim();
                 if (!rejectionReason) {
                     showNotification('‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶â‡¶≤‡ßç‡¶≤‡ßá‡¶ñ ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï‡•§', 'error');
                     return;
                 }
                 // üî• ‡¶®‡¶§‡ßÅ‡¶®: ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£‡¶∏‡¶π ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞ ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ
                 window.handleRejectProof(data.taskId, data.proofId, data.userId, rejectionReason);
            } else if (actionType === 'approveProof') {
                window.handleApproveProof(data.taskId, data.proofId, data.userId, data.points); 
            }
            
            closeModeratorModal(); // ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ
        };

        window.onclick = function(event) {
            if (event.target === moderatorModal) {
                closeModeratorModal();
            }
        };
        // End Modal functions


        /**
         * ‡¶Æ‡¶°‡¶æ‡¶∞‡ßá‡¶ü‡¶∞ ‡¶¨‡¶æ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶∞‡ßã‡¶≤ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶®‡¶æ ‡¶™‡ßá‡¶≤‡ßá ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡•§
         * @param {string} userId - ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ UID
         */
        const checkModeratorRole = (userId) => {
             const userRef = ref(rtdb, `users/${userId}/role`);
             onValue(userRef, (snapshot) => {
                 const role = snapshot.val();
                 // Admin can also access the moderator page
                 if (role !== 'moderator' && role !== 'admin') { 
                     showNotification("‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á! ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Æ‡¶°‡¶æ‡¶∞‡ßá‡¶ü‡¶∞ ‡¶¨‡¶æ ‡¶è‡¶°‡¶Æ‡¶ø‡¶®‡¶∞‡¶æ‡¶á ‡¶è‡¶á ‡¶™‡ßá‡¶ú‡ßá ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§", 'error');
                     // ‡¶Ö‡¶®‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ï‡ßá ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá ‡¶™‡¶æ‡¶†‡¶ø‡¶Ø‡¶º‡ßá ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ
                     setTimeout(() => { window.location.href = 'index.html'; }, 1500); 
                 } else {
                     startDataListeners(); // ‡¶Ø‡¶¶‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
                 }
             }, { onlyOnce: true });
        };


        // AUTH CHECK - Ensures user is logged in and starts role check
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                checkModeratorRole(currentUserId); 
            } else {
                window.location.href = 'login.html';
            }
        });
        
        // ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
        const startDataListeners = () => {
            // ‡ßß. ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ï‡¶∞‡¶æ (‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®)
            onValue(ref(rtdb, 'users'), (snapshot) => {
                const users = snapshot.val() || {};
                allUsersData = users; // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            });

            // ‡ß®. ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
            const tasksRef = ref(rtdb, 'tasks');
            onValue(tasksRef, (snapshot) => {
                const tasks = snapshot.val() || {};
                renderProofs(tasks); 
                loadingIndicator.classList.add('hidden');
            }, (error) => {
                console.error("User tasks load error:", error);
                proofsGrid.innerHTML = '<div class="col-span-full text-center py-12 text-red-500 text-lg">‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§</div>';
                loadingIndicator.classList.add('hidden');
            });
        }
        
        /**
         * ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∞‡¶≠‡ßá‡¶¶‡ßá‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶á‡¶ï‡¶® ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßá‡•§
         */
        const getTaskTypeIcon = (type) => {
            switch(type.toLowerCase()) {
                case 'like': return 'fa-thumbs-up text-blue-600';
                case 'comment': return 'fa-comment text-indigo-600';
                case 'share': return 'fa-share text-cyan-600';
                case 'follow': return 'fa-user-plus text-purple-600';
                case 'group': return 'fa-users text-teal-600'; // ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
                default: return 'fa-list-check text-gray-600';
            }
        };

        /**
         * ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶õ‡¶¨‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶ú‡ßá‡¶®‡ßá‡¶∞‡¶ø‡¶ï ‡¶™‡ßç‡¶≤‡ßá‡¶∏‡¶π‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
         */
        const getProfileAvatarHtml = (userName, photoUrl, isVerified) => {
            let avatarHtml;
            const initial = (userName.charAt(0) || 'A').toUpperCase();

            if (photoUrl) {
                avatarHtml = `<img src="${photoUrl}" alt="${userName} Profile" class="profile-avatar" onerror="this.onerror=null; this.src='https://placehold.co/40x40/a5b4fc/ffffff?text=${initial}'; this.className='avatar-placeholder';">`;
            } else {
                avatarHtml = `<div class="avatar-placeholder">${initial}</div>`;
            }
            let badgeHtml = isVerified ? `<span class="verified-badge"><i class="fa fa-check" aria-hidden="true"></i></span>` : '';
            return `<div class="profile-photo-container">${avatarHtml}${badgeHtml}</div>`;
        };

        // Function to render proofs
        const renderProofs = (tasks) => {
            proofsGrid.innerHTML = '';
            let proofsFound = false;
            
            const proofsToRender = [];

            for (const taskId in tasks) {
                const task = tasks[taskId];
                if (task.proofs) {
                    for (const proofId in task.proofs) {
                        const proof = task.proofs[proofId];
                        
                        if (proof.status === 'pending') {
                            proofsFound = true;
                            // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ï‡¶∞‡¶æ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
                            const userData = allUsersData[proof.userId] || {};
                            
                            proofsToRender.push({ taskId, proofId, task, proof, userData });
                        }
                    }
                }
            }

            if (!proofsFound) {
                proofsGrid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500 text-lg">üéâ ‡¶è‡¶ñ‡¶® ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶®‡ßá‡¶á‡•§</div>';
                return;
            }

            proofsToRender.forEach(({ taskId, proofId, task, proof, userData }) => {
                const userDisplayName = userData.facebookName || proof.facebookName || '‡¶®‡¶æ‡¶Æ ‡¶®‡ßá‡¶á';
                const { profilePhotoUrl, isVerified } = userData;

                const taskIconClass = getTaskTypeIcon(task.taskType);
                const avatarHtml = getProfileAvatarHtml(userDisplayName, profilePhotoUrl, isVerified);
                
                const proofCard = `
                    <div class="proof-card">
                        <div class="flex items-center justify-between mb-4 pb-4 border-b">
                            <div class="flex items-center gap-3">
                                <i class="fas ${taskIconClass} text-2xl"></i>
                                <div>
                                    <h4 class="font-bold text-gray-800">${task.taskType} ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï</h4>
                                    <p class="text-sm text-gray-500 font-semibold">
                                        ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü: <span class="text-green-600">+${(task.pointsPerTask).toLocaleString('bn-BD')}</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-3 mb-6 text-sm">
                            <div class="flex items-center gap-3 p-2 bg-indigo-50 rounded-lg border border-indigo-200">
                                ${avatarHtml} 
                                <div class="flex-1 truncate">
                                    <p class="font-bold text-gray-800 truncate leading-tight">${userDisplayName}</p>
                                    <p class="text-xs text-gray-500 font-mono truncate">
                                        ID: ${proof.userId.substring(0, 10)}...
                                    </p>
                                </div>
                            </div>
                            <p>
                                <span class="font-medium text-gray-700">‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶≤‡¶ø‡¶Ç‡¶ï:</span> 
                                <a href="${task.taskLink}" target="_blank" class="brand-blue-text hover:underline break-all block text-xs">${task.taskLink}</a>
                            </p>
                            <p>
                                <span class="font-medium text-gray-700">‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶®‡¶æ‡¶Æ:</span> 
                                <span class="font-semibold text-gray-800 break-all block text-xs">${proof.facebookName}</span>
                            </p>
                            
                            <!-- üî• ‡¶Ü‡¶™‡¶°‡ßá‡¶ü: ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü ‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá -->
                            ${proof.screenshotUrl ? `
                                <div class="mt-4 pt-4 border-t border-gray-100">
                                    <span class="font-medium text-gray-700 block mb-2"><i class="fas fa-image text-green-500 mr-2"></i> ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü ‡¶™‡ßç‡¶∞‡ßÅ‡¶´:</span>
                                    <img src="${proof.screenshotUrl}" alt="‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü ‡¶™‡ßç‡¶∞‡ßÅ‡¶´" 
                                         class="w-full h-auto max-h-48 object-contain rounded-lg border border-gray-200 cursor-pointer"
                                         onclick="window.open('${proof.screenshotUrl}', '_blank')" />
                                </div>
                            ` : (proof.facebookLink ? `<p class="text-xs text-red-500 italic">‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶°‡ßá‡¶ü‡¶æ, ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶Ü‡¶õ‡ßá: <a href="${proof.facebookLink}" target="_blank" class="text-blue-500">‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</a></p>` : '')}

                        </div>
                        <div class="flex gap-4">
                            <button class="flex-1 bg-green-500 text-white py-2.5 rounded-lg font-bold text-sm hover:bg-green-600 transition duration-200" onclick="openModeratorModal('approveProof', { taskId: '${taskId}', proofId: '${proofId}', userId: '${proof.userId}', points: ${task.pointsPerTask} })">
                                <i class="fas fa-check-circle mr-1"></i> ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®
                            </button>
                            <button class="flex-1 bg-red-500 text-white py-2.5 rounded-lg font-bold text-sm hover:bg-red-600 transition duration-200" onclick="openModeratorModal('rejectProof', { taskId: '${taskId}', proofId: '${proofId}', userId: '${proof.userId}' })">
                                <i class="fas fa-times-circle mr-1"></i> ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
                            </button>
                        </div>
                    </div>
                `;
                proofsGrid.insertAdjacentHTML('beforeend', proofCard);
            });
        };
        
        // ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® (‡¶Æ‡¶°‡¶æ‡¶∞‡ßá‡¶ü‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã)
        // üî• ‡¶Ü‡¶™‡¶°‡ßá‡¶ü: trustScore +5 ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
        window.handleApproveProof = async (taskId, proofId, userId, pointsToAdd) => {
            showNotification("‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ö‡¶≤‡¶õ‡ßá...", 'info');
            
            const APPROVE_trust_CHANGE = 5; // ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø +5
            
            if (!currentUserId) {
                showNotification('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡¶°‡¶æ‡¶∞‡ßá‡¶ü‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§', 'error');
                return;
            }
            
            const proofRef = ref(rtdb, `tasks/${taskId}/proofs/${proofId}`);
            const userRef = ref(rtdb, `users/${userId}`);
            const taskRef = ref(rtdb, `tasks/${taskId}`);
            
            try {
                // ‡ßß. ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶ö‡ßá‡¶ï ‡¶è‡¶¨‡¶Ç ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                const snapshot = await get(proofRef);
                const currentProof = snapshot.val();
                if (!currentProof || currentProof.status !== 'pending') {
                    showNotification('‡¶è‡¶á ‡¶™‡ßç‡¶∞‡ßÅ‡¶´‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'error');
                    return;
                }

                // üî• Fix: ‡¶Æ‡¶°‡¶æ‡¶∞‡ßá‡¶ü‡¶∞‡ßá‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø (currentUserId) ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Æ‡¶Ø‡¶º (reviewedAt) ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
                await update(proofRef, { status: 'approved', reviewedBy: currentUserId, reviewedAt: Date.now() });
                
                // ‡ß®. ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü, ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç trust Score ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                const userUpdatePromise = runTransaction(userRef, (currentData) => {
                    if (currentData) {
                        const newPoints = (currentData.points || 0) + pointsToAdd;
                        const newTasksCompleted = (currentData.tasksCompleted || 0) + 1;
                        
                        // üî• trust Score ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                        const currenttrustScore = currentData.trustScore || 0;
                        const newtrustScore = currenttrustScore + APPROVE_trust_CHANGE;
                        
                        currentData.points = newPoints;
                        currentData.tasksCompleted = newTasksCompleted;
                        // üî• ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: trustScore ‡¶ï‡ßá ‡ß¶ ‡¶•‡ßá‡¶ï‡ßá ‡ßß‡ß¶‡ß¶ ‡¶è‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∏‡ßÄ‡¶Æ‡¶æ‡¶¨‡¶¶‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ
                        currentData.trustScore = Math.min(100, Math.max(0, newtrustScore));
                        
                        currentData.completedTasks = currentData.completedTasks || {};
                        currentData.completedTasks[taskId] = 'approved'; 
                        
                        // üî• ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∏‡¶æ‡¶∏‡¶™‡ßá‡¶®‡¶∂‡¶® ‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ ‡¶™‡ßç‡¶∞‡¶≠‡¶æ‡¶¨ ‡¶´‡ßá‡¶≤‡¶¨‡ßá ‡¶®‡¶æ, ‡¶§‡¶¨‡ßá ‡¶Ø‡¶¶‡¶ø ‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶ ‡¶∂‡ßá‡¶∑ ‡¶π‡¶Ø‡¶º‡ßá ‡¶•‡¶æ‡¶ï‡ßá ‡¶§‡¶¨‡ßá ‡¶§‡¶æ ‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶¨‡ßá
                        if (currentData.suspension && currentData.suspension.suspendUntil && currentData.suspension.suspendUntil < Date.now()) {
                            // üî• ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: suspension ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                            currentData.suspension = null; 
                        }
                    }
                    return currentData; 
                });
                
                // ‡ß©. ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï‡ßá‡¶∞ completedCount ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                const taskUpdatePromise = runTransaction(taskRef, (currentData) => {
                    if (currentData) {
                        currentData.completedCount = (currentData.completedCount || 0) + 1;
                        if (currentData.quantity && currentData.completedCount >= currentData.quantity) {
                            currentData.status = 'completed';
                        }
                    }
                    return currentData;
                });
                
                const [userResult, taskResult] = await Promise.all([userUpdatePromise, taskUpdatePromise]);
                
                if (userResult.committed && userResult.snapshot.val() && taskResult.committed) {
                    const finaltrustScore = userResult.snapshot.val().trustScore;
                    showNotification(`‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá (+${pointsToAdd} ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü, ‡¶ï‡ßç‡¶∞‡ßá‡¶°‡¶ø‡¶¨‡¶ø‡¶≤‡¶ø‡¶ü‡¶ø ‡¶∏‡ßç‡¶ï‡ßã‡¶∞ +${APPROVE_trust_CHANGE})! ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ï‡ßã‡¶∞: ${finaltrustScore}`, 'success');
                } else if (userResult.committed === false || taskResult.committed === false) {
                     showNotification('‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶ú ‡¶ï‡¶®‡¶∏‡ßã‡¶≤ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error');
                } else {
                     showNotification('‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø! ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ï‡¶∞‡¶£‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡¶§‡¶æ‡•§', 'error');
                }
                
            } catch (error) {
                console.error("Error approving proof:", error);
                showNotification("‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ï‡¶∞‡¶£‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶ï‡¶®‡¶∏‡ßã‡¶≤‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§", 'error');
            }
        };

        // üî• ‡¶Ü‡¶™‡¶°‡ßá‡¶ü: ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£‡¶∏‡¶π ‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        // üî• ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: ‡¶∏‡¶æ‡¶∏‡¶™‡ßá‡¶®‡¶∂‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶ñ‡¶® users/{uid}/suspension ‡¶™‡¶æ‡¶•‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡¶¨‡ßá
        window.handleRejectProof = async (taskId, proofId, userId, rejectionReason) => {
            showNotification("‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ö‡¶≤‡¶õ‡ßá...", 'info');
            
            if (!currentUserId) {
                showNotification('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡¶°‡¶æ‡¶∞‡ßá‡¶ü‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§', 'error');
                return;
            }
            
            const proofRef = ref(rtdb, `tasks/${taskId}/proofs/${proofId}`);
            const userRef = ref(rtdb, `users/${userId}`);
            
            try {
                // ‡ßß. ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶ö‡ßá‡¶ï
                const snapshot = await get(proofRef);
                const currentProof = snapshot.val();
                if (!currentProof || currentProof.status !== 'pending') {
                    showNotification('‡¶è‡¶á ‡¶™‡ßç‡¶∞‡ßÅ‡¶´‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'error');
                    return;
                }
                
                // ‡ß®. ‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                await update(proofRef, { 
                    status: 'rejected', 
                    reviewedBy: currentUserId, 
                    reviewedAt: Date.now(),
                    rejectionReason: rejectionReason 
                });
                
                // ‡ß©. ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡¶§‡¶æ ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü, completedTasks ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶è‡¶¨‡¶Ç trust Score ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                let suspendedDurationText = GENERIC_WARNING; // ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶®‡¶ø‡¶Ç ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú
                let suspensionDataToSet = null; // ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶æ‡¶∏‡¶™‡ßá‡¶®‡¶∂‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø

                const userResult = await runTransaction(userRef, (currentData) => {
                    if (currentData) {
                        currentData.tasksRejected = (currentData.tasksRejected || 0) + 1;
                        currentData.completedTasks = currentData.completedTasks || {};
                        delete currentData.completedTasks[taskId];
                        
                        // üî• trust Score ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                        const currenttrustScore = currentData.trustScore || 100;
                        const newtrustScore = currenttrustScore + REJECT_trust_CHANGE;
                        currentData.trustScore = Math.min(100, Math.max(0, newtrustScore)); 
                        
                        // üî• ‡¶∏‡¶æ‡¶∏‡¶™‡ßá‡¶®‡¶∂‡¶® ‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó
                        let suspensionDurationMs = 0;
                        let suspensionText = null;
                        const currentSuspensionUntil = currentData.suspension?.suspendUntil || 0;
                        
                        for (const rule of SUSPENSION_RULES) {
                            if (currentData.trustScore <= rule.score) {
                                if (rule.durationMs > suspensionDurationMs) {
                                    suspensionDurationMs = rule.durationMs;
                                    suspensionText = rule.durationText;
                                }
                            }
                        }

                        if (suspensionDurationMs > 0) {
                            const suspensionEndTime = Date.now() + suspensionDurationMs;
                            
                            if (suspensionEndTime > currentSuspensionUntil) {
                                const reasonMessage = `trust Score ${currentData.trustScore} ‡¶è ‡¶™‡ßå‡¶Å‡¶õ‡¶æ‡¶®‡ßã‡ßü ${suspensionText} ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶æ‡¶∏‡¶™‡ßá‡¶®‡ßç‡¶°‡•§`;
                                
                                // ‡¶∏‡¶æ‡¶∏‡¶™‡ßá‡¶®‡¶∂‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶§‡ßà‡¶∞‡¶ø
                                suspensionDataToSet = {
                                    suspended: true,
                                    suspendUntil: suspensionEndTime,
                                    reason: reasonMessage,
                                    issuedBy: currentUserId, 
                                    issuedAt: Date.now()
                                };
                                
                                // ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶¨‡¶æ‡¶á‡¶∞‡ßá ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶æ‡¶∏‡¶™‡ßá‡¶®‡¶∂‡¶® ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                                suspendedDurationText = suspensionText;
                                
                                // üî•üî•üî• ‡¶Æ‡ßÇ‡¶≤ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: suspension ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡¶ü‡¶ø ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                                currentData.suspension = suspensionDataToSet;
                            }
                        } else if (currentSuspensionUntil && currentSuspensionUntil < Date.now()) {
                            // ‡¶Ø‡¶¶‡¶ø ‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶Ø‡¶º ‡¶è‡¶¨‡¶Ç ‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶∏‡¶æ‡¶∏‡¶™‡ßá‡¶®‡¶∂‡¶® ‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶‡ßã‡¶§‡ßç‡¶§‡ßÄ‡¶∞‡ßç‡¶£ ‡¶π‡¶Ø‡¶º, ‡¶§‡¶¨‡ßá ‡¶è‡¶ü‡¶ø ‡¶∏‡¶æ‡¶´ ‡¶ï‡¶∞‡¶æ
                            currentData.suspension = null; 
                        }
                    }
                    return currentData;
                });
                
                // ‡ß™. ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶è‡¶¨‡¶Ç ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®
                if (userResult.committed && userResult.snapshot.val()) {
                    const finaltrustScore = userResult.snapshot.val().trustScore;
                    
                    let notificationMessage = `‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá (‡¶ï‡ßç‡¶∞‡ßá‡¶°‡¶ø‡¶¨‡¶ø‡¶≤‡¶ø‡¶ü‡¶ø ‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ${REJECT_trust_CHANGE})‡•§ ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ï‡ßã‡¶∞: ${finaltrustScore}‡•§`;
                    
                    if (userResult.snapshot.val().suspension && userResult.snapshot.val().suspension.suspended) {
                        notificationMessage += ` **‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ï‡ßá ${suspendedDurationText} ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶æ‡¶∏‡¶™‡ßá‡¶®‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§**`;
                    } else {
                        notificationMessage += ` **‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: "${GENERIC_WARNING}"**`;
                    }
                    
                    showNotification(notificationMessage, 'warning'); 
                } else {
                    showNotification('‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶ú ‡¶ï‡¶®‡¶∏‡ßã‡¶≤ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error');
                }
                
            } catch (error) {
                console.error("Error rejecting proof:", error);
                showNotification(`‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ${error.message || '‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø'}‡•§`, 'error');
            }
        };
        
        // Expose modal handler functions to the window object
        window.openModeratorModal = openModeratorModal;
        window.handleApproveProof = handleApproveProof;
        window.handleRejectProof = handleRejectProof;
        
    </script>
</body>
</html>

