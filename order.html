<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</title>
    <script src="https://cdn.tailwindcss.com"> </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* ‡¶´‡¶®‡ßç‡¶ü ‡¶ì ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® */
        body {
            font-family: 'Hind Siliguri', Inter, sans-serif;
            background-color: #f7f9fc;
            min-height: 100vh;
        }

        /* ‡¶¨‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ - ‡¶Ü‡¶ß‡ßÅ‡¶®‡¶ø‡¶ï ‡¶®‡ßÄ‡¶≤ */
        .brand-blue {
            background-color: #0d6efd;
            transition: background-color 0.2s;
        }
        
        .brand-blue:hover {
            background-color: #0b5ed7;
        }

        .brand-blue-text {
            color: #0d6efd;
        }

        /* ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ - ‡¶è‡¶≤‡¶ø‡¶≠‡ßá‡¶ü‡ßá‡¶° ‡¶≤‡ßÅ‡¶ï */
        .app-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
            transition: box-shadow 0.3s, transform 0.2s;
        }

        .app-card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        /* ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤‡¶ø‡¶Ç */
        .app-input {
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 12px;
            font-size: 16px;
            background-color: white;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .app-input:focus {
            outline: none;
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        /* ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤‡¶ø‡¶Ç */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            color: white;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.info { background-color: #3b82f6; }
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }
        
        /* ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-active { background-color: #d1fae5; color: #059669; } /* Green */
        .status-completed { background-color: #bfdbfe; color: #1d4ed8; } /* Blue */
        .status-closed { background-color: #fee2e2; color: #dc2626; } /* Red */

    </style>
</head>
<body class="p-4 flex flex-col items-center justify-center">
    
    <div class="container max-w-2xl w-full">

        <header class="app-card p-6 text-center mb-6 md:mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 flex items-center justify-center gap-4">
                <i class="fas fa-plus-circle text-blue-500 text-3xl md:text-4xl"></i>
                ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶æ‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
            </h1>
            <p class="text-gray-500 font-semibold mt-2">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤ ‡¶è‡¶ô‡ßç‡¶ó‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡¶æ‡¶°‡¶º‡¶æ‡¶®!</p>
        </header>

        <main class="app-card p-4 md:p-6 mb-8">
            <p class="points-display text-center text-lg font-bold mb-6">
                ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü: <span id="current-points" class="brand-blue-text">‡ß¶</span>
            </p>

            <form id="createOrderForm" class="space-y-4">
                
                <div class="form-group text-left">
                    <label for="taskType" class="block text-sm font-medium text-gray-700 mb-2">
                        ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶ß‡¶∞‡¶£:
                    </label>
                    <select id="taskType" name="taskType" class="app-input w-full">
                        <!-- ‡¶∏‡ßç‡¶•‡¶ø‡¶∞ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶ñ‡¶∞‡¶ö ‡¶è‡¶ñ‡¶® ‡¶Ö‡¶™‡¶∂‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá -->
                        <option value="like">‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï ‡¶≤‡¶æ‡¶á‡¶ï (‡ß® ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü)</option>
                        <option value="comment">‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï ‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü (‡ß© ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü)</option>
                        <option value="share">‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ (‡ß´ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü)</option>
                        <option value="follow">‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï ‡¶´‡¶≤‡ßã (‡ß™ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü)</option>
                        <option value="group">‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ ‡¶ú‡ßü‡ßá‡¶® (‡ß¨ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü)</option>
                    </select>
                </div>
                
                <!-- ‡¶®‡¶§‡ßÅ‡¶®: ‡¶∏‡ßç‡¶•‡¶ø‡¶∞ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶ñ‡¶∞‡¶ö ‡¶™‡ßç‡¶∞‡¶¶‡¶∞‡ßç‡¶∂‡¶® -->
                <div class="bg-red-50 p-4 rounded-lg text-left border border-red-200">
                    <label class="block text-sm font-semibold text-red-700 mb-1">
                        ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶ñ‡¶∞‡¶ö (‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø):
                    </label>
                    <span id="per-task-cost-display" class="text-2xl font-extrabold text-red-600">‡ß®</span>
                    <span class="text-lg text-red-700">‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü</span>
                    <!-- ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã ‡¶á‡¶®‡¶™‡ßÅ‡¶ü, ‡¶Ø‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá JavaScript ‡¶Æ‡¶æ‡¶®‡¶ü‡¶ø ‡¶ß‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶´‡¶∞‡ßç‡¶Æ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá -->
                    <input type="hidden" id="taskPoints" name="taskPoints" value="2">
                </div>
                
                <div class="form-group text-left">
                    <label for="taskLink" class="block text-sm font-medium text-gray-700 mb-2">
                        ‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï ‡¶≤‡¶ø‡¶Ç‡¶ï:
                    </label>
                    <!-- üî• ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: type="text" ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‡¶Ø‡¶æ‡¶§‡ßá https:// ‡¶®‡¶æ ‡¶≤‡¶ø‡¶ñ‡¶≤‡ßá‡¶ì ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶®‡¶æ ‡¶π‡¶Ø‡¶º -->
                    <input type="text" id="taskLink" name="taskLink" class="app-input w-full" placeholder="‡¶™‡ßã‡¶∏‡ßç‡¶ü/‡¶≠‡¶ø‡¶°‡¶ø‡¶ì/‡¶™‡ßá‡¶ú ‡¶è‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï" required>
                    <p class="text-xs text-gray-500 mt-1">‡¶Ü‡¶™‡¶®‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶® ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá‡¶ì ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶≤‡¶ø‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: facebook.com/post123), ‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶≠‡¶æ‡¶¨‡ßá 'https://' ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶¨‡ßá‡•§</p>
                </div>
                
                <div class="form-group text-left">
                    <label for="taskQuantity" class="block text-sm font-medium text-gray-700 mb-2">
                        ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡¶ï‡¶§‡¶ó‡ßÅ‡¶≤‡ßã ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá):
                    </label>
                    <input type="number" id="taskQuantity" name="taskQuantity" min="1" value="10" class="app-input w-full" required>
                </div>
                
                <div class="bg-blue-50 p-4 rounded-lg text-center font-bold">
                    ‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö: <span id="total-cost-display" class="brand-blue-text">‡ß¶</span> ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü
                </div>

                <button type="submit" class="w-full brand-blue text-white font-bold py-3 px-4 rounded-lg hover:shadow-lg transition duration-200" id="submit-button">
                    ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </form>
        </main>
        
        <section class="app-card p-4 md:p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center border-b pb-4">
                üìã ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶ï‡¶æ‡¶ú (‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø)
            </h2>
            <div id="order-history-list" class="space-y-4">
                <p class="text-center text-gray-500" id="history-loading-message">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
            </div>
        </section>
        <div class="text-center mt-4">
            <a href="index.html" class="inline-flex items-center bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-full shadow-lg hover:shadow-xl transition-all duration-300">
                <i class="fas fa-arrow-left mr-2"></i>
                ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®
            </a>
        </div>
    </div>
    
    <div id="notification-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
    
    <script type="module" src="./rtdb-config.js"></script>
    <script type="module">
        import { auth, rtdb as db, showNotification, set, ref, get, update, push, runTransaction, onValue, query, orderByChild, equalTo } from "./rtdb-config.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js"; 
        
        // ‡¶∏‡ßç‡¶•‡¶ø‡¶∞ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶ñ‡¶∞‡¶ö ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ
        const FIXED_POINT_COSTS = {
            'like': 2,    // ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶¨‡¶æ ‡¶™‡ßá‡¶ú‡ßá ‡ßß‡¶ü‡¶æ ‡¶≤‡¶æ‡¶á‡¶ï
            'comment': 3, // ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ
            'share': 5,   // ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶ü‡¶æ‡¶á‡¶Æ‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶¨‡¶æ ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™‡ßá ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞
            'follow': 4,  // ‡¶™‡ßá‡¶ú ‡¶¨‡¶æ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶´‡¶≤‡ßã ‡¶ï‡¶∞‡¶æ
            'group': 6    // ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™‡ßá ‡¶Ø‡ßã‡¶ó‡¶¶‡¶æ‡¶®
        };

        // DOM ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏
        const currentPointsDisplay = document.getElementById('current-points');
        const totalCostDisplay = document.getElementById('total-cost-display');
        const form = document.getElementById('createOrderForm');
        // taskPointsInput ‡¶è‡¶ñ‡¶® ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã ‡¶á‡¶®‡¶™‡ßÅ‡¶ü, taskTypeInput ‡¶®‡¶§‡ßÅ‡¶®‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Ç‡¶ú‡ßç‡¶û‡¶æ‡ßü‡¶ø‡¶§
        const taskTypeInput = document.getElementById('taskType');
        const taskPointsInput = document.getElementById('taskPoints'); // Hidden input
        const perTaskCostDisplay = document.getElementById('per-task-cost-display'); // New display element
        const taskQuantityInput = document.getElementById('taskQuantity');
        const orderHistoryList = document.getElementById('order-history-list'); 
        const historyLoadingMessage = document.getElementById('history-loading-message'); 
        
        let userId = null; 
        let userRef = null;

        /**
         * ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶ü‡¶æ‡¶á‡¶™ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶≤‡ßá ‡¶∏‡ßç‡¶•‡¶ø‡¶∞ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶ñ‡¶∞‡¶ö ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßá‡•§
         */
        const updateTaskCostDisplay = () => {
            const selectedTaskType = taskTypeInput.value;
            const cost = FIXED_POINT_COSTS[selectedTaskType] || 0;
            
            // ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            taskPointsInput.value = cost; 
            perTaskCostDisplay.textContent = cost.toLocaleString('bn-BD'); 
            
            calculateTotalCost();
        };

        const calculateTotalCost = () => {
            // taskPointsInput ‡¶è‡¶ñ‡¶® hidden, ‡¶è‡¶¨‡¶Ç ‡¶è‡¶∞ ‡¶Æ‡¶æ‡¶® FIXED_POINT_COSTS ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶∏‡ßá
            const points = parseInt(taskPointsInput.value) || 0;
            const quantity = parseInt(taskQuantityInput.value) || 0;
            const total = points * quantity;
            totalCostDisplay.textContent = total.toLocaleString('bn-BD');
        };

        // ‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞: ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶ü‡¶æ‡¶á‡¶™ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶≤‡ßá ‡¶ñ‡¶∞‡¶ö ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
        taskTypeInput.addEventListener('change', updateTaskCostDisplay);
        // ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶∞‡¶æ‡¶ñ‡¶æ
        taskQuantityInput.addEventListener('input', calculateTotalCost);
        
        
        /**
         * ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ï‡ßá HTTP/HTTPS ‡¶™‡ßç‡¶∞‡ßã‡¶ü‡ßã‡¶ï‡¶≤ ‡¶∏‡¶π ‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶æ‡¶ô‡ßç‡¶ó ‡¶≤‡¶ø‡¶Ç‡¶ï‡ßá ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞ ‡¶ï‡¶∞‡ßá‡•§
         * @param {string} link - ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶ï ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶≤‡¶ø‡¶Ç‡¶ï
         * @returns {string} - ‡¶™‡ßç‡¶∞‡ßã‡¶ü‡ßã‡¶ï‡¶≤‡¶∏‡¶π ‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶æ‡¶ô‡ßç‡¶ó ‡¶≤‡¶ø‡¶Ç‡¶ï
         */
        const normalizeLink = (link) => {
            let normalized = link.trim();
            
            // ‡¶Ø‡¶¶‡¶ø ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ü‡¶ø ‡¶´‡¶æ‡¶ï‡¶æ ‡¶®‡¶æ ‡¶π‡¶Ø‡¶º ‡¶è‡¶¨‡¶Ç http/https/ftp ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶®‡¶æ ‡¶π‡¶Ø‡¶º, ‡¶§‡¶¨‡ßá https:// ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá
            if (normalized && !normalized.match(/^(f|ht)tps?:\/\//i)) {
                normalized = 'https://' + normalized;
            }
            return normalized;
        };

        /**
         * ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡•§
         * @param {string} status - ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ('active', 'completed', 'closed')
         */
        const getStatusBadge = (status) => {
            switch(status) {
                case 'active':
                    return '<span class="status-badge status-active"><i class="fas fa-running mr-1"></i> ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º</span>';
                case 'completed':
                    return '<span class="status-badge status-completed"><i class="fas fa-flag-checkered mr-1"></i> ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®</span>';
                case 'closed':
                    return '<span class="status-badge status-closed"><i class="fas fa-times-circle mr-1"></i> ‡¶¨‡¶®‡ßç‡¶ß</span>';
                default:
                    return '<span class="status-badge bg-gray-200 text-gray-700">‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ</span>';
            }
        };

        /**
         * ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï‡¶ó‡ßÅ‡¶≤‡ßã ‡¶™‡ßç‡¶∞‡¶¶‡¶∞‡ßç‡¶∂‡¶® ‡¶ï‡¶∞‡ßá‡•§
         * @param {Array<Object>} tasks - ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∞‡ßá
         */
        const displayOrderHistory = (tasks) => {
            orderHistoryList.innerHTML = '';
            historyLoadingMessage.classList.add('hidden'); 

            if (tasks.length === 0) {
                orderHistoryList.innerHTML = '<p class="text-center text-gray-500 py-6">‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶æ‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶®‡¶®‡¶ø‡•§</p>';
                return;
            }
            
            // ‡¶®‡¶§‡ßÅ‡¶® ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ
            tasks.sort((a, b) => b.createdAt - a.createdAt);

            tasks.forEach(task => {
                const totalCost = task.pointsPerTask * task.quantity;
                const completedPercentage = task.quantity > 0 ? Math.round((task.completedCount || 0) / task.quantity * 100) : 100;
                const statusBadge = getStatusBadge(task.status);

                const taskCard = `
                    <div class="app-card p-5">
                        <div class="flex justify-between items-start mb-4 pb-4 border-b">
                            <div>
                                <h4 class="text-xl font-semibold text-gray-800">${task.taskType} ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï</h4>
                                <p class="text-sm text-gray-500 mt-1">
                                    ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø: <span class="font-mono text-xs bg-gray-100 px-2 py-0.5 rounded">${task.id.substring(0, 10)}...</span>
                                </p>
                            </div>
                            ${statusBadge}
                        </div>

                        <div class="grid grid-cols-2 gap-4 text-sm text-gray-600 mb-4">
                            <p>
                                <i class="fas fa-coins text-yellow-500 mr-2"></i>
                                ‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö: <span class="font-bold text-gray-800">${totalCost.toLocaleString('bn-BD')}</span> ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü
                            </p>
                            <p>
                                <i class="fas fa-bullseye text-blue-500 mr-2"></i>
                                ‡¶Æ‡ßã‡¶ü ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø: <span class="font-bold text-gray-800">${task.quantity.toLocaleString('bn-BD')} ‡¶ü‡¶ø</span>
                            </p>
                        </div>
                        
                        <div class="flex justify-between items-center mb-4">
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-check-double text-green-500 mr-2"></i>
                                ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®: <span class="font-bold text-green-600">${(task.completedCount || 0).toLocaleString('bn-BD')} ‡¶ü‡¶ø</span>
                            </p>
                            <span class="text-sm font-bold text-gray-700">${completedPercentage}%</span>
                        </div>
                        
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                            <div class="bg-green-600 h-2.5 rounded-full" style="width: ${completedPercentage}%"></div>
                        </div>
                        
                        <div class="flex gap-2">
                            <a href="${task.taskLink}" target="_blank" class="flex-1 text-center bg-gray-200 text-gray-700 py-2 rounded-lg font-bold text-sm hover:bg-gray-300 transition duration-200">
                                <i class="fas fa-link mr-1"></i> ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶≤‡¶ø‡¶Ç‡¶ï
                            </a>
                            <a href="review_prof.html?taskId=${task.id}" class="flex-1 text-center brand-blue text-white py-2 rounded-lg font-bold text-sm hover:brightness-110 transition duration-200">
                                <i class="fas fa-file-circle-check mr-1"></i> ‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á
                            </a>
                        </div>
                    </div>
                `;
                orderHistoryList.insertAdjacentHTML('beforeend', taskCard);
            });
        };


        /**
         * ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤‡¶ü‡¶æ‡¶á‡¶Æ ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßá‡•§
         * @param {string} currentUserId - ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ UID
         */
        const listenForUserTasks = (currentUserId) => {
            const tasksRef = ref(db, 'tasks');
            // ownerId ‡¶´‡¶ø‡¶≤‡ßç‡¶°‡ßá‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø ‡¶ï‡¶∞‡ßá ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∞‡¶ø ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
            const userTasksQuery = query(tasksRef, orderByChild('ownerId'), equalTo(currentUserId));
            
            onValue(userTasksQuery, (snapshot) => {
                const tasksData = snapshot.val() || {};
                const tasksArray = Object.keys(tasksData).map(key => ({ id: key, ...tasksData[key] }));
                
                displayOrderHistory(tasksArray);
                
            }, (error) => {
                console.error("User tasks load error:", error);
                historyLoadingMessage.textContent = '‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§';
            });
        };

        // Firebase Auth State Listener ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "login.html"; 
                return;
            }

            userId = user.uid; 
            userRef = ref(db, `users/${userId}`); 
            
            // ‡¶™‡ßç‡¶∞‡¶æ‡¶•‡¶Æ‡¶ø‡¶ï ‡¶≤‡ßã‡¶°‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ
            updateTaskCostDisplay();

            // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶æ
            listenForUserTasks(userId); 

            // ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤‡¶ü‡¶æ‡¶á‡¶Æ‡ßá ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
            onValue(userRef, (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    currentPointsDisplay.textContent = (userData.points || 0).toLocaleString('bn-BD');
                    calculateTotalCost(); 
                } else {
                    currentPointsDisplay.textContent = '‡ß¶';
                }
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const taskType = form['taskType'].value;
                const taskLinkRaw = form['taskLink'].value; // üî• ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: raw input ‡¶®‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶≤‡ßã
                // taskPoints ‡¶è‡¶ñ‡¶® ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶∏‡¶õ‡ßá, ‡¶è‡¶¨‡¶Ç ‡¶è‡¶∞ ‡¶Æ‡¶æ‡¶® FIXED_POINT_COSTS ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡¶æ‡¶á‡¶®‡¶æ‡¶Æ‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                const taskPoints = parseInt(form['taskPoints'].value);
                const taskQuantity = parseInt(form['taskQuantity'].value);
                const totalCost = taskPoints * taskQuantity;
                
                // üî• ‡¶®‡¶§‡ßÅ‡¶®: ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶®‡¶∞‡¶Æ‡¶æ‡¶≤‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
                const taskLink = normalizeLink(taskLinkRaw); 

                try {
                    const userSnapshot = await get(userRef);
                    const currentPoints = userSnapshot.val().points || 0;

                    if (currentPoints < totalCost) {
                        showNotification('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§', 'error');
                        return;
                    }
                    
                    // üî• ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶®: ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ü‡¶ø ‡¶Ø‡ßá‡¶® ‡¶´‡¶æ‡¶ï‡¶æ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá
                    if (taskLink.trim() === 'https://') {
                         showNotification('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶¶‡¶ø‡¶®‡•§', 'error');
                         return;
                    }


                    // ‡ßß. ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶æ‡¶ü‡¶æ
                    const transactionResult = await runTransaction(userRef, (currentData) => {
                        if (currentData) {
                            if ((currentData.points || 0) >= totalCost) {
                                currentData.points = (currentData.points || 0) - totalCost;
                                currentData.tasksCreated = (currentData.tasksCreated || 0) + 1;
                            } else {
                                return; 
                            }
                        }
                        return currentData;
                    });

                    if (!transactionResult || !transactionResult.committed) {
                        showNotification('‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶æ‡¶ü‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§', 'error');
                        return;
                    }
                    
                    // ‡ß®. ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶ï‡¶æ‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ
                    const tasksListRef = ref(db, 'tasks');
                    const newTaskRef = push(tasksListRef);
                    const taskId = newTaskRef.key;

                    const newTaskData = {
                        id: taskId,
                        ownerId: userId,
                        taskType: taskType,
                        taskLink: taskLink, // üî• ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
                        pointsPerTask: taskPoints,
                        quantity: taskQuantity,
                        completedCount: 0, 
                        proofs: {},
                        status: 'active',
                        createdAt: Date.now()
                    };
                    await set(newTaskRef, newTaskData);
                    
                    showNotification('‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡¶∞‡¶ø‡¶§‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§', 'success');
                    form.reset();
                    
                } catch (error) {
                    console.error("‡¶ï‡¶æ‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ", error);
                    showNotification(`‡¶ï‡¶æ‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ${error.message || '‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø'}`, 'error');
                }
            });
        });
    </script>
</body>
</html>

