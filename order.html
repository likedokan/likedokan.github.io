<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</title>
    <script src="https://cdn.tailwindcss.com"> </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* ‡¶´‡¶®‡ßç‡¶ü ‡¶ì ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® */
        body {
            font-family: 'Hind Siliguri', Inter, sans-serif;
            background-color: #f7f9fc;
            min-height: 100vh;
        }

        /* ‡¶¨‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ - ‡¶Ü‡¶ß‡ßÅ‡¶®‡¶ø‡¶ï ‡¶®‡ßÄ‡¶≤ */
        .brand-blue {
            background-color: #0d6efd;
            transition: background-color 0.2s;
        }
        
        .brand-blue:hover {
            background-color: #0b5ed7;
        }

        .brand-blue-text {
            color: #0d6efd;
        }

        /* ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ - ‡¶è‡¶≤‡¶ø‡¶≠‡ßá‡¶ü‡ßá‡¶° ‡¶≤‡ßÅ‡¶ï */
        .app-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
            transition: box-shadow 0.3s, transform 0.2s;
        }

        .app-card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        /* ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤‡¶ø‡¶Ç */
        .app-input {
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 12px;
            font-size: 16px;
            background-color: white;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .app-input:focus {
            outline: none;
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        /* ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤‡¶ø‡¶Ç */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            color: white;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.info { background-color: #3b82f6; }
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }
        
        /* ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-active { background-color: #d1fae5; color: #059669; } /* Green */
        .status-completed { background-color: #bfdbfe; color: #1d4ed8; } /* Blue */
        .status-closed { background-color: #fee2e2; color: #dc2626; } /* Red */
        
        .loading-text {
            color: #6b7280;
            font-weight: 500;
        }
        
        /* ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .history-item-compact {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .history-item-compact:hover {
            background-color: #f8fafc;
        }

        .history-item-compact:last-child {
            border-bottom: none;
        }
        
        .progress-bar-container {
            width: 100px; /* ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶• ‡¶Ø‡¶æ‡¶§‡ßá ‡¶ï‡¶Æ‡ßç‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü ‡¶•‡¶æ‡¶ï‡ßá */
            min-width: 100px;
            height: 6px;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
            margin-left: 0.75rem;
        }

        .progress-bar {
            height: 100%;
            background-color: #10b981; /* Green */
            transition: width 0.3s;
        }
        
    </style>
</head>
<body class="p-4 flex flex-col items-center justify-center">
    
    <div class="container max-w-2xl w-full">

        <header class="app-card p-6 text-center mb-6 md:mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 flex items-center justify-center gap-4">
                <i class="fas fa-plus-circle text-blue-500 text-3xl md:text-4xl"></i>
                ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶æ‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
            </h1>
            <p class="text-gray-500 font-semibold mt-2">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤ ‡¶è‡¶ô‡ßç‡¶ó‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡¶æ‡¶°‡¶º‡¶æ‡¶®!</p>
        </header>

        <main class="app-card p-4 md:p-6 mb-8">
            <p class="points-display text-center text-lg font-bold mb-6">
                ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü: <span id="current-points" class="brand-blue-text">‡ß¶</span>
            </p>

            <form id="createOrderForm" class="space-y-4">
                
                <div class="form-group text-left">
                    <label for="taskType" class="block text-sm font-medium text-gray-700 mb-2">
                        ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶ß‡¶∞‡¶£:
                    </label>
                    <!-- ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∏‡¶∞‡ßç‡¶¨‡¶¶‡¶æ ‡¶è‡¶ü‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá -->
                    <select id="taskType" name="taskType" class="app-input w-full"> 
                        <!-- ‡¶Ö‡¶™‡¶∂‡¶®‡¶ó‡ßÅ‡¶≤‡ßã JS ‡¶è ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá, ‡¶§‡¶¨‡ßá ‡¶™‡ßç‡¶∞‡¶æ‡¶•‡¶Æ‡¶ø‡¶ï ‡¶Ö‡¶™‡¶∂‡¶® ‡¶®‡¶ø‡¶ö‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá -->
                    </select>
                </div>
                
                <!-- ‡¶®‡¶§‡ßÅ‡¶®: ‡¶∏‡ßç‡¶•‡¶ø‡¶∞ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶ñ‡¶∞‡¶ö ‡¶™‡ßç‡¶∞‡¶¶‡¶∞‡ßç‡¶∂‡¶® -->
                <div class="bg-red-50 p-4 rounded-lg text-left border border-red-200">
                    <label class="block text-sm font-semibold text-red-700 mb-1">
                        ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶ñ‡¶∞‡¶ö (‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø):
                    </label>
                    <span id="per-task-cost-display" class="text-2xl font-extrabold text-red-600 loading-text">‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>
                    <span class="text-lg text-red-700">‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü</span>
                    <input type="hidden" id="taskPoints" name="taskPoints" value="0">
                </div>
                
                <div class="form-group text-left">
                    <label for="taskLink" class="block text-sm font-medium text-gray-700 mb-2">
                        ‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï ‡¶≤‡¶ø‡¶Ç‡¶ï:
                    </label>
                    <input type="text" id="taskLink" name="taskLink" class="app-input w-full" placeholder="‡¶™‡ßã‡¶∏‡ßç‡¶ü/‡¶≠‡¶ø‡¶°‡¶ø‡¶ì/‡¶™‡ßá‡¶ú ‡¶è‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï" required>
                    <p class="text-xs text-gray-500 mt-1">‡¶Ü‡¶™‡¶®‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶® ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá‡¶ì ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶≤‡¶ø‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: facebook.com/post123), ‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶≠‡¶æ‡¶¨‡ßá 'https://' ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶¨‡ßá‡•§</p>
                </div>
                
                <div class="form-group text-left">
                    <label for="taskQuantity" class="block text-sm font-medium text-gray-700 mb-2">
                        ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡¶ï‡¶§‡¶ó‡ßÅ‡¶≤‡ßã ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá):
                    </label>
                    <input type="number" id="taskQuantity" name="taskQuantity" min="1" value="10" class="app-input w-full" required>
                </div>
                
                <div class="bg-blue-50 p-4 rounded-lg text-center font-bold">
                    ‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö: <span id="total-cost-display" class="brand-blue-text">‡ß¶</span> ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü
                </div>

                <button type="submit" class="w-full brand-blue text-white font-bold py-3 px-4 rounded-lg hover:shadow-lg transition duration-200" id="submit-button" disabled>
                    <i class="fas fa-spinner fa-spin mr-2" id="submit-loading-icon" style="display: inline-block;"></i>
                    <span id="submit-button-text">‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>
                </button>
            </form>
        </main>
        
        <section class="app-card p-4 md:p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center border-b pb-4">
                üìã ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶ï‡¶æ‡¶ú (‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø)
            </h2>
            <div id="order-history-list" class="space-y-4">
                <p class="text-center text-gray-500" id="history-loading-message">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
            </div>
        </section>
        <div class="text-center mt-4">
            <a href="index.html" class="inline-flex items-center bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-full shadow-lg hover:shadow-xl transition-all duration-300">
                <i class="fas fa-arrow-left mr-2"></i>
                ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®
            </a>
        </div>
    </div>
    
    <div id="notification-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
    
    <script type="module" src="./rtdb-config.js"></script>
    <script type="module">
        import { auth, rtdb as db, showNotification, set, ref, get, update, push, runTransaction, onValue, query, orderByChild, equalTo } from "./rtdb-config.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js"; 
        
        let POINT_COSTS = {}; // ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶ú ‡¶•‡ßá‡¶ï‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá
        let isPointsLoaded = false; // üî• ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ü‡ßá‡¶ü ‡¶´‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ó: ‡¶¶‡¶æ‡¶Æ ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ

        // DOM ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏
        const currentPointsDisplay = document.getElementById('current-points');
        const totalCostDisplay = document.getElementById('total-cost-display');
        const form = document.getElementById('createOrderForm');
        
        const taskTypeInput = document.getElementById('taskType');
        const taskPointsInput = document.getElementById('taskPoints'); // Hidden input
        const perTaskCostDisplay = document.getElementById('per-task-cost-display'); // New display element
        const taskQuantityInput = document.getElementById('taskQuantity');
        const orderHistoryList = document.getElementById('order-history-list'); 
        const historyLoadingMessage = document.getElementById('history-loading-message'); 
        const submitButton = document.getElementById('submit-button'); 
        const submitLoadingIcon = document.getElementById('submit-loading-icon');
        const submitButtonText = document.getElementById('submit-button-text');
        
        let userId = null; 
        let userRef = null;
        
        // ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∞‡¶≠‡ßá‡¶¶ ‡¶è‡¶¨‡¶Ç ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá ‡¶®‡¶æ‡¶Æ (‡¶∏‡ßç‡¶•‡¶ø‡¶∞)
        const TASK_TYPES_MAP = {
            'react': '‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶ï‡ßç‡¶ü',
            'comment': '‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü',
            'share': '‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞',
            'follow': '‡¶´‡¶≤‡ßã',
            'groupJoin': '‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ ‡¶ú‡ßü‡ßá‡¶®' // ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶ú ‡¶ï‡ßÄ 'groupJoin'
        };

        // üî• ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶™‡ßç‡¶∞‡¶æ‡¶•‡¶Æ‡¶ø‡¶ï ‡¶Ö‡¶™‡¶∂‡¶® ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ (‡¶¶‡¶æ‡¶Æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá‡¶á)
        const renderInitialTaskOptions = () => {
            taskTypeInput.innerHTML = '';
            
            // ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü "‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá..." ‡¶Ö‡¶™‡¶∂‡¶®
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶ß‡¶∞‡¶£ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            taskTypeInput.appendChild(defaultOption);

            let firstSelectableValue = null;

            // ‡¶∏‡ßç‡¶•‡¶ø‡¶∞ MAP ‡¶•‡ßá‡¶ï‡ßá ‡¶Ö‡¶™‡¶∂‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ (‡¶¶‡¶æ‡¶Æ ‡¶õ‡¶æ‡¶°‡¶º‡¶æ‡¶á)
            for (const key in TASK_TYPES_MAP) {
                 const option = document.createElement('option');
                 option.value = key;
                 option.textContent = TASK_TYPES_MAP[key]; 
                 taskTypeInput.appendChild(option);

                 if (firstSelectableValue === null) {
                     firstSelectableValue = key;
                 }
            }
            
            // ‡¶™‡ßç‡¶∞‡¶æ‡¶•‡¶Æ‡¶ø‡¶ï ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ (‡¶ï‡ßã‡¶®‡ßã ‡¶ñ‡¶∞‡¶ö ‡¶®‡ßá‡¶á, ‡¶Ø‡¶§‡¶ï‡ßç‡¶∑‡¶£ ‡¶®‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá)
            taskPointsInput.value = 0; 
            perTaskCostDisplay.textContent = '‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
            totalCostDisplay.textContent = '‡ß¶';

            // ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶™‡¶∂‡¶® ‡¶•‡¶æ‡¶ï‡ßá, ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡¶ü‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ
            if (firstSelectableValue) {
                // taskTypeInput.value = firstSelectableValue; // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡¶ü‡¶ø ‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶≠‡¶æ‡¶¨‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ï‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡¶≤‡¶æ ‡¶π‡¶≤‡ßã
            }
        };


        /**
         * ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶¨‡¶æ‡¶ü‡¶®‡¶ï‡ßá ‡¶§‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶≤‡ßã‡¶° ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßá‡•§
         */
        const updateSubmitButtonStatus = () => {
            // ‡¶Ø‡¶¶‡¶ø ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶®‡¶æ ‡¶π‡¶Ø‡¶º OR ‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶®‡¶æ ‡¶π‡¶Ø‡¶º, ‡¶¨‡¶æ‡¶ü‡¶® ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§
            const isInvalidSelection = !taskTypeInput.value || parseInt(taskPointsInput.value) <= 0;
            
            if (isPointsLoaded && !isInvalidSelection) {
                // ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá ‡¶ó‡ßá‡¶≤‡ßá ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶†‡¶ø‡¶ï ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶π‡¶≤‡ßá ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶π‡¶¨‡ßá
                submitButton.disabled = false;
                submitLoadingIcon.style.display = 'none';
                submitButtonText.textContent = '‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®';
            } else {
                // ‡¶Ö‡¶®‡ßç‡¶Ø‡¶•‡¶æ‡¶Ø‡¶º ‡¶¨‡¶æ‡¶ü‡¶® ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
                submitButton.disabled = true;
                
                if (!isPointsLoaded) {
                    // ‡¶Ø‡¶¶‡¶ø ‡¶¶‡¶æ‡¶Æ ‡¶≤‡ßã‡¶° ‡¶®‡¶æ ‡¶π‡¶Ø‡¶º
                    submitLoadingIcon.style.display = 'inline-block';
                    submitButtonText.textContent = '‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
                } else {
                    // ‡¶¶‡¶æ‡¶Æ ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶¨‡¶æ ‡¶ï‡ßã‡¶Ø‡¶º‡¶æ‡¶®‡ßç‡¶ü‡¶ø‡¶ü‡¶ø ‡¶†‡¶ø‡¶ï ‡¶®‡ßá‡¶á
                    submitLoadingIcon.style.display = 'none';
                    submitButtonText.textContent = '‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®';
                }
            }
        };


        /**
         * ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶ü‡¶æ‡¶á‡¶™ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶≤‡ßá ‡¶∏‡ßç‡¶•‡¶ø‡¶∞ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶ñ‡¶∞‡¶ö ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßá‡•§
         */
        const updateTaskCostDisplay = () => {
            const selectedTaskType = taskTypeInput.value;
            // POINT_COSTS ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡¶æ‡¶á‡¶®‡¶æ‡¶Æ‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶ñ‡¶∞‡¶ö ‡¶®‡ßá‡¶ì‡ßü‡¶æ (‡¶≤‡ßã‡¶° ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ ‡¶°‡ßá‡¶ü‡¶æ)
            const cost = POINT_COSTS[selectedTaskType] || 0; 
            
            // ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            taskPointsInput.value = cost; 
            
            if (isPointsLoaded) {
                 // ‡¶¶‡¶æ‡¶Æ ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá ‡¶ó‡ßá‡¶≤‡ßá ‡¶Ü‡¶∏‡¶≤ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
                perTaskCostDisplay.textContent = cost.toLocaleString('bn-BD'); 
                perTaskCostDisplay.classList.remove('loading-text');
            } else {
                // ‡¶¶‡¶æ‡¶Æ ‡¶≤‡ßã‡¶° ‡¶®‡¶æ ‡¶π‡¶≤‡ßá ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶∞‡¶æ‡¶ñ‡¶æ
                perTaskCostDisplay.textContent = '‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
                perTaskCostDisplay.classList.add('loading-text');
            }
            
            calculateTotalCost();
        };

        const calculateTotalCost = () => {
            const points = parseInt(taskPointsInput.value) || 0;
            const quantity = parseInt(taskQuantityInput.value) || 0;
            const total = points * quantity;
            totalCostDisplay.textContent = total.toLocaleString('bn-BD');

            // ‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö ‡¶ó‡¶£‡¶®‡¶æ ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            updateSubmitButtonStatus();
        };
        
        /**
         * Firebase ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶è‡¶¨‡¶Ç UI ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
         */
        const loadTaskPoints = () => {
            const pointsRef = ref(db, 'controls/productPoints');
            
            onValue(pointsRef, (snapshot) => {
                const fetchedCosts = snapshot.val() || {};
                
                POINT_COSTS = fetchedCosts; 
                let hasValidData = false;
                
                // üî• ‡¶Ö‡¶™‡¶∂‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ: ‡¶è‡¶ñ‡¶® ‡¶¶‡¶æ‡¶Æ ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá‡¶§‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá
                const selectedValue = taskTypeInput.value;
                taskTypeInput.innerHTML = '';

                // ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü "‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶ß‡¶∞‡¶£ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®" ‡¶Ö‡¶™‡¶∂‡¶®‡¶ü‡¶ø ‡¶∞‡¶æ‡¶ñ‡¶æ
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶ß‡¶∞‡¶£ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®';
                defaultOption.disabled = true;
                taskTypeInput.appendChild(defaultOption);


                for (const key in POINT_COSTS) {
                    const cost = POINT_COSTS[key];
                    if (cost > 0 && TASK_TYPES_MAP[key]) { 
                         hasValidData = true;
                         const option = document.createElement('option');
                         option.value = key;
                         // ‡¶Ö‡¶™‡¶∂‡¶®‡ßá ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá ‡¶®‡¶æ‡¶Æ + ‡¶≤‡ßã‡¶° ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ñ‡¶∞‡¶ö ‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
                         option.textContent = `${TASK_TYPES_MAP[key]} (${cost.toLocaleString('bn-BD')} ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü)`; 
                         taskTypeInput.appendChild(option);
                    }
                }
                
                if (hasValidData) {
                    // ‡¶Ø‡¶¶‡¶ø ‡¶≤‡ßã‡¶° ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ ‡¶°‡ßá‡¶ü‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶° ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º
                    taskTypeInput.value = selectedValue; // ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡¶æ
                    
                    if (!taskTypeInput.value) {
                         // ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá ‡¶¨‡¶æ ‡¶á‡¶®‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶° ‡¶π‡¶Ø‡¶º, ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶Ö‡¶™‡¶∂‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ
                         taskTypeInput.value = '';
                         defaultOption.selected = true;
                    }
                    
                } else {
                    // ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø
                    taskTypeInput.innerHTML = '<option value="" disabled selected>‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï‡ßá‡¶∞ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§</option>';
                    taskPointsInput.value = 0;
                    showNotification('‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßá‡¶®‡¶ø‡•§', 'error', 10000);
                }
                
                // üî• ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá, ‡¶§‡¶æ‡¶á ‡¶´‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ó ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                isPointsLoaded = true;

                // ‡¶∏‡¶¨‡¶∂‡ßá‡¶∑‡ßá UI ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                updateTaskCostDisplay(); 
                
            }, (error) => {
                console.error("Error loading task points:", error);
                // ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶≤‡ßá‡¶ì isPointsLoaded ‡¶´‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ó false ‡¶•‡¶æ‡¶ï‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶æ‡¶ü‡¶® ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§
                isPointsLoaded = false;
                taskTypeInput.innerHTML = '<option value="" disabled selected>‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§</option>';
                perTaskCostDisplay.textContent = '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø';
                perTaskCostDisplay.classList.remove('loading-text');
                updateSubmitButtonStatus(); // ‡¶¨‡¶æ‡¶ü‡¶® ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá
                showNotification('‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'error');
            });
        };

        // üî• ‡¶™‡ßç‡¶∞‡¶æ‡¶•‡¶Æ‡¶ø‡¶ï ‡¶Ö‡¶™‡¶∂‡¶® ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ (‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá‡¶á, ‡¶¶‡¶æ‡¶Æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá‡¶á)
        renderInitialTaskOptions();

        // ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶∞‡¶æ‡¶ñ‡¶æ
        taskTypeInput.addEventListener('change', updateTaskCostDisplay);
        taskQuantityInput.addEventListener('input', calculateTotalCost);
        
        
        /**
         * ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ï‡ßá HTTP/HTTPS ‡¶™‡ßç‡¶∞‡ßã‡¶ü‡ßã‡¶ï‡¶≤ ‡¶∏‡¶π ‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶æ‡¶ô‡ßç‡¶ó ‡¶≤‡¶ø‡¶Ç‡¶ï‡ßá ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞ ‡¶ï‡¶∞‡ßá‡•§
         */
        const normalizeLink = (link) => {
            let normalized = link.trim();
            
            if (normalized && !normalized.match(/^(https?|http):\/\//i)) {
                normalized = 'https://' + normalized;
            }
            return normalized;
        };

        /**
         * ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡•§
         */
        const getStatusBadge = (status) => {
            switch(status) {
                case 'active':
                    return '<span class="status-badge status-active"><i class="fas fa-running mr-1"></i> ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º</span>';
                case 'completed':
                    return '<span class="status-badge status-completed"><i class="fas fa-flag-checkered mr-1"></i> ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®</span>';
                case 'closed':
                    return '<span class="status-badge status-closed"><i class="fas fa-times-circle mr-1"></i> ‡¶¨‡¶®‡ßç‡¶ß</span>';
                default:
                    return '<span class="status-badge bg-gray-200 text-gray-700">‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ</span>';
            }
        };

        /**
         * ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï‡¶ó‡ßÅ‡¶≤‡ßã ‡¶™‡ßç‡¶∞‡¶¶‡¶∞‡ßç‡¶∂‡¶® ‡¶ï‡¶∞‡ßá‡•§
         */
        const displayOrderHistory = (tasks) => {
            orderHistoryList.innerHTML = '';
            historyLoadingMessage.classList.add('hidden'); 

            if (tasks.length === 0) {
                orderHistoryList.innerHTML = '<p class="text-center text-gray-500 py-6">‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶æ‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶®‡¶®‡¶ø‡•§</p>';
                return;
            }
            
            tasks.sort((a, b) => b.createdAt - a.createdAt);

            tasks.forEach(task => {
                const totalCost = task.pointsPerTask * task.quantity;
                const completedCount = task.completedCount || 0;
                const completedPercentage = task.quantity > 0 ? Math.min(100, Math.round(completedCount / task.quantity * 100)) : 100;
                const statusBadge = getStatusBadge(task.status);
                
                const taskDisplayName = TASK_TYPES_MAP[task.taskType] || task.taskType;
                
                const taskCard = `
                    <div class="history-item-compact border-t md:border-t-0 hover:bg-gray-50 flex-col md:flex-row md:items-center" onclick="window.location.href='review_prof.html?taskId=${task.id}'">
                        
                        <!-- ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶ü‡¶æ‡¶á‡¶™ ‡¶ì ‡¶Ü‡¶á‡¶°‡¶ø -->
                        <div class="flex-1 min-w-0 mb-2 md:mb-0">
                            <h4 class="text-base font-bold text-gray-800 truncate">${taskDisplayName}</h4>
                            <p class="text-xs text-gray-500 mt-0.5">
                                ${new Date(task.createdAt).toLocaleDateString('bn-BD')} ‡¶è ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
                            </p>
                        </div>
                        
                        <!-- ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∂‡¶§‡¶æ‡¶Ç‡¶∂ ‡¶ì ‡¶™‡ßç‡¶∞‡¶ó‡ßç‡¶∞‡ßá‡¶∏ ‡¶¨‡¶æ‡¶∞ -->
                        <div class="flex items-center w-full md:w-auto mb-2 md:mb-0">
                            <span class="text-sm font-semibold text-gray-700 w-12 text-right">${completedPercentage}%</span>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${completedPercentage}%"></div>
                            </div>
                        </div>
                        
                        <!-- ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ -->
                        <div class="w-20 text-center text-sm font-medium text-gray-700 hidden md:block">
                            ${completedCount}/${task.quantity.toLocaleString('bn-BD')}
                        </div>
                        
                        <!-- ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶ì ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶¨‡¶æ‡¶ü‡¶® -->
                        <div class="w-full md:w-36 flex justify-between items-center md:justify-end ml-0 md:ml-4">
                            ${statusBadge}
                            <a href="review_prof.html?taskId=${task.id}" class="text-blue-500 hover:text-blue-700 ml-3 md:hidden">
                                <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                        
                        <!-- ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶§‡¶•‡ßç‡¶Ø -->
                        <div class="text-xs text-gray-500 w-full md:hidden pt-1 border-t mt-1">
                             <p>‡¶Æ‡ßã‡¶ü ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø: ${task.quantity.toLocaleString('bn-BD')}, ‡¶ñ‡¶∞‡¶ö: ${totalCost.toLocaleString('bn-BD')} ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü</p>
                        </div>

                    </div>
                `;
                orderHistoryList.insertAdjacentHTML('beforeend', taskCard);
            });
            
            orderHistoryList.classList.add('border', 'border-gray-200', 'rounded-lg', 'divide-y', 'divide-gray-100');
        };


        /**
         * ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤‡¶ü‡¶æ‡¶á‡¶Æ ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßá‡•§
         */
        const listenForUserTasks = (currentUserId) => {
            const tasksRef = ref(db, 'tasks');
            const userTasksQuery = query(tasksRef, orderByChild('ownerId'), equalTo(currentUserId));
            
            onValue(userTasksQuery, (snapshot) => {
                const tasksData = snapshot.val() || {};
                const tasksArray = Object.keys(tasksData).map(key => ({ id: key, ...tasksData[key] }));
                
                displayOrderHistory(tasksArray);
                
            }, (error) => {
                console.error("User tasks load error:", error);
                historyLoadingMessage.textContent = '‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§';
            });
        };

        // Firebase Auth State Listener ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "login.html"; 
                return;
            }

            userId = user.uid; 
            userRef = ref(db, `users/${userId}`); 
            
            // üî• ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
            loadTaskPoints();

            // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶æ
            listenForUserTasks(userId); 

            // ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤‡¶ü‡¶æ‡¶á‡¶Æ‡ßá ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
            onValue(userRef, (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    currentPointsDisplay.textContent = (userData.points || 0).toLocaleString('bn-BD');
                    calculateTotalCost(); 
                } else {
                    currentPointsDisplay.textContent = '‡ß¶';
                }
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // üî• ‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶´‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ó ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ
                if (!isPointsLoaded) {
                     showNotification('‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶ñ‡¶®‡ßã ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï ‡¶Æ‡ßÅ‡¶π‡ßÇ‡¶∞‡ßç‡¶§ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'warning');
                     return;
                }

                // ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∞‡¶≠‡ßá‡¶¶ ‡¶è‡¶¨‡¶Ç ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶®
                const taskType = taskTypeInput.value;
                const taskPoints = parseInt(taskPointsInput.value);
                
                if (!taskType || taskPoints <= 0) {
                     showNotification('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ø‡¶æ‡¶∞ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá‡•§', 'error');
                     return;
                }
                
                const taskLinkRaw = form['taskLink'].value; 
                const taskQuantity = parseInt(form['taskQuantity'].value);
                const totalCost = taskPoints * taskQuantity;
                
                const taskLink = normalizeLink(taskLinkRaw); 

                try {
                    const userSnapshot = await get(userRef);
                    const currentPoints = userSnapshot.val().points || 0;

                    if (currentPoints < totalCost) {
                        showNotification('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§', 'error');
                        return;
                    }
                    
                    if (taskLink.trim() === 'https://') {
                         showNotification('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶¶‡¶ø‡¶®‡•§', 'error');
                         return;
                    }
                    
                    // ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º ‡¶∞‡¶æ‡¶ñ‡¶æ
                    submitButton.disabled = true;
                    submitLoadingIcon.style.display = 'inline-block';
                    submitButtonText.textContent = '‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';


                    // ‡ßß. ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶æ‡¶ü‡¶æ
                    const transactionResult = await runTransaction(userRef, (currentData) => {
                        if (currentData) {
                            if ((currentData.points || 0) >= totalCost) {
                                currentData.points = (currentData.points || 0) - totalCost;
                                currentData.tasksCreated = (currentData.tasksCreated || 0) + 1;
                            } else {
                                return; 
                            }
                        }
                        return currentData;
                    });

                    if (!transactionResult || !transactionResult.committed) {
                        showNotification('‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶æ‡¶ü‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§', 'error');
                        updateSubmitButtonStatus(); 
                        return;
                    }
                    
                    // ‡ß®. ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶ï‡¶æ‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ
                    const tasksListRef = ref(db, 'tasks');
                    const newTaskRef = push(tasksListRef);
                    const taskId = newTaskRef.key;

                    const newTaskData = {
                        id: taskId,
                        ownerId: userId,
                        taskType: taskType,
                        taskLink: taskLink, 
                        pointsPerTask: taskPoints,
                        quantity: taskQuantity,
                        completedCount: 0, 
                        proofs: {},
                        status: 'active',
                        createdAt: Date.now()
                    };
                    await set(newTaskRef, newTaskData);
                    
                    showNotification('‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡¶∞‡¶ø‡¶§‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§', 'success');
                    form.reset();
                    
                } catch (error) {
                    console.error("‡¶ï‡¶æ‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ", error);
                    showNotification(`‡¶ï‡¶æ‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ${error.message || '‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø'}`, 'error');
                } finally {
                    updateSubmitButtonStatus(); // ‡¶∏‡¶´‡¶≤ ‡¶¨‡¶æ ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶≤‡ßá‡¶ì ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡¶æ
                }
            });
        });
    </script>
</body>
</html>

