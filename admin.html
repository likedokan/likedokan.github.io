<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</title>
    <script src="https://cdn.tailwindcss.com"> </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ‡¶´‡¶®‡ßç‡¶ü ‡¶ì ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® */
        body {
            font-family: 'Hind Siliguri', Inter, sans-serif;
            background-color: #f7f9fc;
        }

        /* ‡¶¨‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ - ‡¶Ü‡¶ß‡ßÅ‡¶®‡¶ø‡¶ï ‡¶®‡ßÄ‡¶≤ */
        .brand-blue {
            background-color: #0d6efd;
            transition: background-color 0.2s;
        }

        .brand-blue:hover {
            background-color: #0b5ed7;
        }

        .brand-blue-text {
            color: #0d6efd;
        }

        /* ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ - ‡¶è‡¶≤‡¶ø‡¶≠‡ßá‡¶ü‡ßá‡¶° ‡¶≤‡ßÅ‡¶ï */
        .app-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
            transition: box-shadow 0.3s, transform 0.2s;
        }

        .app-card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        /* ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤‡¶ø‡¶Ç */
        .app-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .app-table th, .app-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
        }

        .app-table thead th {
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 600;
            text-align: left;
            text-transform: uppercase;
            font-size: 0.875rem;
        }

        .app-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .custom-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            transition: opacity 0.3s ease;
        }
        
        .custom-modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 450px; /* ‡¶Æ‡¶°‡¶æ‡¶≤‡ßá‡¶∞ ‡¶∏‡¶æ‡¶á‡¶ú ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶¨‡¶æ‡¶°‡¶º‡¶æ‡¶®‡ßã ‡¶π‡¶≤‡ßã */
            text-align: center;
            animation: zoomIn 0.3s ease-out;
        }
        
        .custom-modal-actions {
            margin-top: 1.5rem;
            display: flex;
            justify-content: space-around;
            gap: 1rem;
        }
        
        .custom-modal-btn {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 9999px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
    </style>
</head>
<body>
    
    <div class="container max-w-6xl mx-auto p-4 md:p-8">
        <header class="app-card p-6 text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center justify-center gap-4">
                <i class="fas fa-tools brand-blue-text"></i>
                ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°
            </h1>
        </header>
        
        <div class="app-card p-6">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-xl font-bold text-gray-800 mb-4 md:mb-0">‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h2>
                <div class="tabs flex flex-wrap gap-2 md:gap-4">
                    <button class="tab px-4 py-2 rounded-full text-sm font-semibold transition-colors duration-200 bg-blue-600 text-white active" data-tab="users">
                        <i class="fas fa-users mr-2"></i> ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ
                    </button>
                    <button class="tab px-4 py-2 rounded-full text-sm font-semibold transition-colors duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300" data-tab="tasks">
                        <i class="fas fa-list-check mr-2"></i> ‡¶ï‡¶æ‡¶ú‡¶∏‡¶Æ‡ßÇ‡¶π
                    </button>
                    <button class="tab px-4 py-2 rounded-full text-sm font-semibold transition-colors duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300" data-tab="proofs">
                        <i class="fas fa-file-circle-check mr-2"></i> ‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â
                    </button>
                </div>
            </div>

            <div id="users" class="tab-content active">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
                <div class="overflow-x-auto">
                    <table class="app-table">
                        <thead>
                            <tr>
                                <th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ID</th>
                                <th>‡¶®‡¶æ‡¶Æ</th>
                                <th>‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü</th>
                                <th>‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á‡¶°</th>
                                <th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="tasks" class="tab-content hidden">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">‡¶ï‡¶æ‡¶ú‡¶∏‡¶Æ‡ßÇ‡¶π ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
                <div class="overflow-x-auto">
                    <table class="app-table">
                        <thead>
                            <tr>
                                <th>‡¶Ü‡¶á‡¶°‡¶ø</th>
                                <th>‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∞</th>
                                <th>‡¶≤‡¶ø‡¶Ç‡¶ï</th>
                                <th>‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü</th>
                                <th>‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</th>
                                <th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                            </tr>
                        </thead>
                        <tbody id="tasks-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div id="proofs" class="tab-content hidden">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶≤‡ßã‡¶ö‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡ßÅ‡¶´</h3>
                <div id="proofs-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Proofs will be rendered here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∂‡¶® ‡¶Æ‡¶°‡¶æ‡¶≤ (Updated for Rejection Reason) -->
    <div id="admin-modal" class="custom-modal">
        <div class="custom-modal-content">
            <h3 class="text-xl font-bold mb-2 text-gray-800" id="modal-title">‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
            <p class="text-gray-600 mb-4" id="modal-message"></p>
            
            <!-- üî• ‡¶®‡¶§‡ßÅ‡¶®: ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü (‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü‡¶∞‡ßÇ‡¶™‡ßá ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã) -->
            <div id="rejection-reason-group" class="mb-4 hidden text-left">
                <label for="rejection-reason" class="block text-sm font-medium text-gray-700 mb-2">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ (‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï):</label>
                <textarea id="rejection-reason" rows="3" class="w-full p-3 border border-red-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="‡¶ï‡ßá‡¶® ‡¶™‡ßç‡¶∞‡ßÅ‡¶´‡¶ü‡¶ø ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶§‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>
            </div>
            
            <div class="custom-modal-actions">
                <button class="custom-modal-btn bg-red-500 text-white hover:bg-red-600" id="modal-confirm-btn">
                    ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
                <button class="custom-modal-btn bg-gray-200 text-gray-800 hover:bg-gray-300" onclick="closeAdminModal()">
                    ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
                </button>
            </div>
        </div>
    </div>

    <div id="notification-container"></div>
    
    <script type="module">
        // Firebase imports from rtdb-config.js
        import { rtdb, ref, onValue, update, remove, get, auth, showNotification, runTransaction } from './rtdb-config.js'; 
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js"; 

        // Get references to the DOM elements
        const usersTableBody = document.querySelector('#users table tbody');
        const tasksTableBody = document.querySelector('#tasks table tbody');
        const proofsGrid = document.getElementById('proofs-grid');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        const adminModal = document.getElementById('admin-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        
        // üî• ‡¶®‡¶§‡ßÅ‡¶® DOM ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏
        const rejectionReasonGroup = document.getElementById('rejection-reason-group');
        const rejectionReasonInput = document.getElementById('rejection-reason');

        let currentUserId = null;
        let pendingAction = { actionType: null, data: null };
        let allUsersData = {};

        // Modal functions
        window.closeAdminModal = () => {
            adminModal.style.display = 'none';
            pendingAction = { actionType: null, data: null }; // ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü
            rejectionReasonInput.value = ''; // üî• ‡¶®‡¶§‡ßÅ‡¶®: ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
        };
        
        const openAdminModal = (type, data) => {
            pendingAction.actionType = type;
            pendingAction.data = data;
            
            let titleText = '‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®';
            let messageText = '';
            let confirmClass = '';
            
            if (type === 'closeTask') {
                titleText = '‡¶ï‡¶æ‡¶ú ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®';
                messageText = `‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ID ${data.taskId.substring(0, 8)}... ‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`;
                confirmClass = 'bg-red-500 hover:bg-red-600';
                rejectionReasonGroup.classList.add('hidden'); // üî• ‡¶®‡¶§‡ßÅ‡¶®: ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã
                modalConfirmBtn.classList.remove('bg-green-500'); // ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ
                modalConfirmBtn.classList.add('bg-red-500');
            } else if (type === 'approveProof') {
                titleText = '‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶¶‡¶ø‡¶®';
                messageText = `‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶™‡ßç‡¶∞‡ßÅ‡¶´‡¶ü‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ï‡ßá ${(data.points).toLocaleString('bn-BD')} ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶¶‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`;
                confirmClass = 'bg-green-500 hover:bg-green-600';
                rejectionReasonGroup.classList.add('hidden'); // üî• ‡¶®‡¶§‡ßÅ‡¶®: ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã
                modalConfirmBtn.classList.remove('bg-red-500'); // ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ
                modalConfirmBtn.classList.add('bg-green-500');
            } else if (type === 'rejectProof') {
                titleText = '‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®';
                messageText = `‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶™‡ßç‡¶∞‡ßÅ‡¶´‡¶ü‡¶ø ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®? ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§ ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶â‡¶≤‡ßç‡¶≤‡ßá‡¶ñ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`;
                confirmClass = 'bg-red-500 hover:bg-red-600';
                rejectionReasonGroup.classList.remove('hidden'); // üî• ‡¶®‡¶§‡ßÅ‡¶®: ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
                rejectionReasonInput.value = ''; // ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
                modalConfirmBtn.classList.remove('bg-green-500'); // ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ
                modalConfirmBtn.classList.add('bg-red-500');
            }

            modalTitle.textContent = titleText;
            modalMessage.textContent = messageText;
            modalConfirmBtn.className = `custom-modal-btn text-white font-bold ${confirmClass}`;
            adminModal.style.display = 'flex';
        };

        // ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞
        modalConfirmBtn.onclick = () => {
            const { actionType, data } = pendingAction;
            
            if (!currentUserId) {
                showNotification('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error');
                return;
            }
            
            if (actionType === 'rejectProof') {
                 const rejectionReason = rejectionReasonInput.value.trim();
                 if (!rejectionReason) {
                     showNotification('‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶â‡¶≤‡ßç‡¶≤‡ßá‡¶ñ ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï‡•§', 'error');
                     return;
                 }
                 // üî• ‡¶®‡¶§‡ßÅ‡¶®: ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£‡¶∏‡¶π ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞ ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ
                 window.handleRejectProof(data.taskId, data.proofId, data.userId, rejectionReason);
            } else if (actionType === 'closeTask') {
                window.handleCloseTask(data.taskId);
            } else if (actionType === 'approveProof') {
                window.handleApproveProof(data.taskId, data.proofId, data.userId, data.points); 
            }
            
            closeAdminModal(); // ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ 
        };

        window.onclick = function(event) {
            if (event.target === adminModal) {
                closeAdminModal();
            }
        };

        // End Modal functions

        /**
         * ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶∞‡ßã‡¶≤ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶®‡¶æ ‡¶™‡ßá‡¶≤‡ßá ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡•§
         * @param {string} userId - ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ UID
         */
        const checkAdminRole = (userId) => {
             const userRef = ref(rtdb, `users/${userId}/role`);
             onValue(userRef, (snapshot) => {
                 const role = snapshot.val();
                 if (role !== 'admin') {
                     showNotification("‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á! ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶è‡¶°‡¶Æ‡¶ø‡¶®‡¶∞‡¶æ‡¶á ‡¶è‡¶á ‡¶™‡ßá‡¶ú‡ßá ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§", 'error');
                     // ‡¶Ö‡¶®‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ï‡ßá ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá ‡¶™‡¶æ‡¶†‡¶ø‡¶Ø‡¶º‡ßá ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ
                     setTimeout(() => { window.location.href = 'index.html'; }, 1500);
                 } else {
                    // ‡¶Ø‡¶¶‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
                    startDataListeners();
                 }
             }, { onlyOnce: true });
        };
        
        // AUTH CHECK - Ensures user is logged in
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                checkAdminRole(currentUserId);
            } else {
                window.location.href = 'login.html';
            }
        });

        const startDataListeners = () => {
            // Listen for users data and cache it
            onValue(ref(rtdb, 'users'), (snapshot) => {
                const users = snapshot.val() || {};
                allUsersData = users; // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                renderUsers(users); 
            });

            // Listen for tasks data
            onValue(ref(rtdb, 'tasks'), (snapshot) => {
                const tasks = snapshot.val() || {};
                renderTasks(tasks);
                renderProofs(tasks); 
            });
        };
        
        /**
         * ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∞‡¶≠‡ßá‡¶¶‡ßá‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶á‡¶ï‡¶® ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßá‡•§
         */
        const getTaskTypeIcon = (type) => {
            switch(type.toLowerCase()) {
                case 'like': return 'fa-thumbs-up text-blue-600';
                case 'comment': return 'fa-comment text-indigo-600';
                case 'share': return 'fa-share text-cyan-600';
                case 'follow': return 'fa-user-plus text-purple-600';
                case 'group': return 'fa-users text-teal-600'; // ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
                default: return 'fa-list-check text-gray-600';
            }
        };

        // Function to render users table 
        const renderUsers = (users) => {
            usersTableBody.innerHTML = '';
            for (const userId in users) {
                const user = users[userId];
                // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶¨‡¶æ ‡¶Æ‡¶°‡¶æ‡¶∞‡ßá‡¶ü‡¶∞‡¶¶‡ßá‡¶∞ ‡¶®‡¶ø‡¶ú‡ßá‡¶∞‡¶æ ‡¶®‡¶ø‡¶ú‡ßá‡¶¶‡ßá‡¶∞ ‡¶∞‡ßã‡¶≤‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶¶‡ßá‡¶¨‡ßá ‡¶®‡¶æ
                if (userId === currentUserId && (user.role === 'admin' || user.role === 'moderator')) {
                    continue; 
                }
                
                const row = document.createElement('tr');
                const displayName = user.facebookName || 'N/A';
                const isVerified = user.isVerified || false;
                
                row.innerHTML = `
                    <td class="text-sm text-gray-500 font-mono break-all">${userId.substring(0, 10)}...</td>
                    <td class="font-medium text-gray-800">${displayName} (${user.role || 'user'})</td>
                    <td class="font-semibold text-green-600">${(user.points || 0).toLocaleString('bn-BD')}</td>
                    <td>
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${isVerified ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${isVerified ? '‡¶π‡ßç‡¶Ø‡¶æ‡¶Å' : '‡¶®‡¶æ'}
                        </span>
                    </td>
                    <td>
                        <button class="px-4 py-2 rounded-full text-sm font-bold text-white transition-colors duration-200 ${isVerified ? 'bg-red-500 hover:bg-red-600' : 'brand-blue hover:brightness-110'}" onclick="toggleVerification('${userId}', ${isVerified})">
                            <i class="fas ${isVerified ? 'fa-ban' : 'fa-user-check'} mr-2"></i>
                            ${isVerified ? '‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡¶∞‡¶æ‡¶®' : '‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®'}
                        </button>
                    </td>
                `;
                usersTableBody.appendChild(row);
            }
        };

        // Function to render tasks table
        const renderTasks = (tasks) => {
            tasksTableBody.innerHTML = '';
            const sortedTasks = Object.keys(tasks).map(key => ({ id: key, ...tasks[key] })).sort((a, b) => b.createdAt - a.createdAt);

            sortedTasks.forEach((task) => {
                const row = document.createElement('tr');
                const taskStatus = task.status || 'N/A';
                const statusColor = taskStatus === 'active' ? 'text-green-600' : 'text-red-600';

                row.innerHTML = `
                    <td class="text-sm text-gray-500 font-mono break-all">${task.id.substring(0, 10)}...</td>
                    <td class="font-medium">${task.taskType || 'N/A'}</td>
                    <td><a href="${task.taskLink}" target="_blank" class="brand-blue-text hover:underline">${task.taskLink ? task.taskLink.substring(0, 30) + '...' : 'N/A'}</a></td>
                    <td class="font-semibold text-yellow-600">${(task.pointsPerTask || 0).toLocaleString('bn-BD')}</td>
                    <td class="font-medium ${statusColor}">${taskStatus === 'active' ? '‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º' : '‡¶¨‡¶®‡ßç‡¶ß'}</td>
                    <td>
                        ${taskStatus === 'active' ? 
                            `<button class="px-4 py-2 rounded-full text-sm font-bold text-white transition-colors duration-200 bg-red-500 hover:bg-red-600" onclick="openAdminModal('closeTask', { taskId: '${task.id}' })">
                                <i class="fas fa-times-circle mr-2"></i> ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
                            </button>`
                        : `<span class="text-gray-500 text-sm italic">‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶¨‡¶®‡ßç‡¶ß</span>`}
                    </td>
                `;
                tasksTableBody.appendChild(row);
            });
        };

        // Function to render proofs - UPDATED to show screenshotFileName instead of facebookLink
        const renderProofs = (tasks) => {
            proofsGrid.innerHTML = '';
            let proofsFound = false;
            
            const proofsToRender = [];

            for (const taskId in tasks) {
                const task = tasks[taskId];
                if (task.proofs) {
                    for (const proofId in task.proofs) {
                        const proof = task.proofs[proofId];
                        
                        if (proof.status === 'pending') {
                            proofsFound = true;
                            // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ï‡¶∞‡¶æ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
                            const userData = allUsersData[proof.userId] || {};
                            
                            proofsToRender.push({ taskId, proofId, task, proof, userData });
                        }
                    }
                }
            }
            
            // ‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶≤‡¶ú‡¶ø‡¶ï
            proofsToRender.forEach(({ taskId, proofId, task, proof, userData }) => {
                // ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá userData, ‡¶Ø‡¶¶‡¶ø ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá ‡¶§‡¶¨‡ßá proof ‡¶•‡ßá‡¶ï‡ßá facebookName ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
                const userDisplayName = userData.facebookName || proof.facebookName || '‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ';
                const taskIconClass = getTaskTypeIcon(task.taskType);
                
                // üî• ‡¶Ü‡¶™‡¶°‡ßá‡¶ü: ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü ‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá
                let proofDataHtml = '';
                if (proof.screenshotUrl) {
                    proofDataHtml = `
                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <span class="font-medium text-gray-700 block mb-2"><i class="fas fa-image text-green-500 mr-2"></i> ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü ‡¶™‡ßç‡¶∞‡ßÅ‡¶´:</span>
                            <img src="${proof.screenshotUrl}" alt="‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü ‡¶™‡ßç‡¶∞‡ßÅ‡¶´" 
                                 class="w-full h-auto max-h-48 object-contain rounded-lg border border-gray-200 cursor-pointer"
                                 onclick="window.open('${proof.screenshotUrl}', '_blank')" />
                        </div>`;
                } else if (proof.facebookLink) { 
                    // ‡¶Ø‡¶¶‡¶ø ‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶•‡¶æ‡¶ï‡ßá (facebookLink), ‡¶∏‡ßá‡¶ü‡¶æ‡¶ì ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶≤‡ßã
                    proofDataHtml = `
                        <p class="text-sm">
                            <span class="font-medium text-gray-700">‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï ‡¶≤‡¶ø‡¶Ç‡¶ï (‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã):</span> 
                            <a href="${proof.facebookLink}" target="_blank" class="brand-blue-text hover:underline break-all">${proof.facebookLink}</a>
                        </p>`;
                }
                
                const proofCard = `
                    <div class="app-card p-5">
                        <div class="flex items-center justify-between mb-4 pb-4 border-b">
                            <div class="flex items-center gap-3">
                                <i class="fas ${taskIconClass} text-2xl"></i>
                                <div>
                                    <h4 class="font-semibold text-gray-800">${userDisplayName}</h4>
                                    <p class="text-sm text-gray-500 font-mono break-all">
                                        ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø: ${proof.userId.substring(0, 10)}...
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-3 mb-6">
                            <p class="text-sm">
                                <span class="font-medium text-gray-700">‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∞:</span> 
                                <span class="font-semibold text-gray-900">${task.taskType}</span>
                            </p>
                            <p class="text-sm">
                                <span class="font-medium text-gray-700">‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶≤‡¶ø‡¶Ç‡¶ï:</span> 
                                <a href="${task.taskLink}" target="_blank" class="brand-blue-text hover:underline break-all">${task.taskLink}</a>
                            </p>
                            <p class="text-sm">
                                <span class="font-medium text-gray-700">‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü:</span> 
                                <span class="font-semibold text-green-600">+${(task.pointsPerTask).toLocaleString('bn-BD')}</span>
                            </p>
                            ${proofDataHtml} 
                        </div>
                        <div class="flex gap-4">
                            <button class="flex-1 brand-blue text-white py-2.5 rounded-lg font-bold hover:brightness-110 transition duration-200" onclick="openAdminModal('approveProof', { taskId: '${taskId}', proofId: '${proofId}', userId: '${proof.userId}', points: ${task.pointsPerTask} })">
                                <i class="fas fa-thumbs-up mr-2"></i> ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®
                            </button>
                            <button class="flex-1 bg-red-500 text-white py-2.5 rounded-lg font-bold hover:bg-red-600 transition duration-200" onclick="openAdminModal('rejectProof', { taskId: '${taskId}', proofId: '${proofId}', userId: '${proof.userId}' })">
                                <i class="fas fa-times-circle mr-2"></i> ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
                            </button>
                        </div>
                    </div>
                `;
                proofsGrid.insertAdjacentHTML('beforeend', proofCard);
            });
            
            if (!proofsFound) {
                proofsGrid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500 text-lg">üéâ ‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶®‡ßá‡¶á‡•§</div>';
            }
        };

        // Global functions for button actions (No change in logic)
        window.toggleVerification = (userId, isVerified) => {
            const userRef = ref(rtdb, `users/${userId}`);
            update(userRef, { isVerified: !isVerified })
                .then(() => showNotification('‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'info'))
                .catch(error => showNotification('‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§', 'error'));
        };

        window.handleCloseTask = (taskId) => {
            showNotification("‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ö‡¶≤‡¶õ‡ßá...", 'info');
            const taskRef = ref(rtdb, `tasks/${taskId}`);
            update(taskRef, { status: 'closed' })
                .then(() => showNotification('‡¶ï‡¶æ‡¶ú ‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'success'))
                .catch(error => showNotification('‡¶ï‡¶æ‡¶ú ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§', 'error'));
        };
        
        // ‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (runTransaction ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá) - ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
        window.handleApproveProof = async (taskId, proofId, userId, pointsToAdd) => {
            showNotification("‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ö‡¶≤‡¶õ‡ßá...", 'info');
            
            if (!currentUserId) {
                showNotification('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§', 'error');
                return;
            }
            
            const proofRef = ref(rtdb, `tasks/${taskId}/proofs/${proofId}`);
            const userRef = ref(rtdb, `users/${userId}`);
            const taskRef = ref(rtdb, `tasks/${taskId}`);
            
            try {
                const snapshot = await get(proofRef);
                const currentProof = snapshot.val();
                if (!currentProof || currentProof.status !== 'pending') {
                    showNotification('‡¶è‡¶á ‡¶™‡ßç‡¶∞‡ßÅ‡¶´‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'error');
                    return;
                }

                // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø (currentUserId) ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Æ‡¶Ø‡¶º (reviewedAt) ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
                await update(proofRef, { status: 'approved', reviewedBy: currentUserId, reviewedAt: Date.now() });
                
                const userUpdatePromise = runTransaction(userRef, (currentData) => {
                    if (currentData) {
                        const newPoints = (currentData.points || 0) + pointsToAdd;
                        const newTasksCompleted = (currentData.tasksCompleted || 0) + 1;
                        
                        currentData.points = newPoints;
                        currentData.tasksCompleted = newTasksCompleted;
                        currentData.completedTasks = currentData.completedTasks || {};
                        currentData.completedTasks[taskId] = 'approved'; 
                    }
                    return currentData;
                });
                
                const taskUpdatePromise = runTransaction(taskRef, (currentData) => {
                    if (currentData) {
                        currentData.completedCount = (currentData.completedCount || 0) + 1;
                        if (currentData.quantity && currentData.completedCount >= currentData.quantity) {
                            currentData.status = 'completed';
                        }
                    }
                    return currentData;
                });

                const [userResult, taskResult] = await Promise.all([userUpdatePromise, taskUpdatePromise]);
                
                if (userResult.committed && userResult.snapshot.val() && taskResult.committed) {
                    showNotification('‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶è‡¶¨‡¶Ç ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
                } else {
                     showNotification('‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶¨‡¶ø‡¶ß‡¶ø ‡¶¨‡¶æ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£‡ßá ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§', 'error');
                }

            } catch (error) {
                console.error("Error approving proof:", error);
                showNotification(`‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ${error.message || '‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø'}‡•§ ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶¨‡¶ø‡¶ß‡¶ø ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`, 'error');
            }
        };

        // üî• ‡¶Ü‡¶™‡¶°‡ßá‡¶ü: ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£‡¶∏‡¶π ‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        window.handleRejectProof = async (taskId, proofId, userId, rejectionReason) => {
            showNotification("‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ö‡¶≤‡¶õ‡ßá...", 'info');
            
            if (!currentUserId) {
                showNotification('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§', 'error');
                return;
            }
            
            const proofRef = ref(rtdb, `tasks/${taskId}/proofs/${proofId}`);
            const userRef = ref(rtdb, `users/${userId}`);
            
            try {
                const snapshot = await get(proofRef);
                const currentProof = snapshot.val();
                if (!currentProof || currentProof.status !== 'pending') {
                    showNotification('‡¶è‡¶á ‡¶™‡ßç‡¶∞‡ßÅ‡¶´‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'error');
                    return;
                }
                
                // üî• ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø (currentUserId), ‡¶∏‡¶Æ‡¶Ø‡¶º (reviewedAt) ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ (rejectionReason) ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
                await update(proofRef, { 
                    status: 'rejected', 
                    reviewedBy: currentUserId, 
                    reviewedAt: Date.now(),
                    rejectionReason: rejectionReason // üî• ‡¶®‡¶§‡ßÅ‡¶®: ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£
                });
                
                const userResult = await runTransaction(userRef, (currentData) => {
                    if (currentData) {
                        currentData.tasksRejected = (currentData.tasksRejected || 0) + 1;
                        currentData.completedTasks = currentData.completedTasks || {};
                        delete currentData.completedTasks[taskId]; 
                    }
                    return currentData;
                });
                
                if (userResult.committed) {
                    showNotification('‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'info');
                } else {
                     showNotification('‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶¨‡¶ø‡¶ß‡¶ø ‡¶¨‡¶æ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£‡ßá ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§', 'error');
                }
                
            } catch (error) {
                console.error("Error rejecting proof:", error);
                showNotification(`‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ${error.message || '‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø'}‡•§ ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶¨‡¶ø‡¶ß‡¶ø ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`, 'error');
            }
        };
        
        // Tab switching logic
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Deactivate all tabs and content
                tabs.forEach(t => {
                    t.classList.remove('bg-blue-600', 'text-white');
                    t.classList.add('bg-gray-200', 'text-gray-700');
                });
                tabContents.forEach(tc => tc.classList.add('hidden'));

                // Activate the clicked tab and its content
                const tabName = tab.dataset.tab;
                document.getElementById(tabName).classList.remove('hidden');
                tab.classList.remove('bg-gray-200', 'text-gray-700');
                tab.classList.add('bg-blue-600', 'text-white');
            });
        });

        // Expose openAdminModal to global scope for button clicks
        window.openAdminModal = openAdminModal;
        window.handleApproveProof = handleApproveProof;
        window.handleRejectProof = handleRejectProof;
    </script>
</body>
</html>

