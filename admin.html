<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>এডমিন ড্যাশবোর্ড</title>
    <script src="https://cdn.tailwindcss.com"> </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ফন্ট ও ব্যাকগ্রাউন্ড কাস্টমাইজেশন */
        body {
            font-family: 'Hind Siliguri', Inter, sans-serif;
            background-color: #f7f9fc;
        }

        /* ব্র্যান্ডিং কালার - আধুনিক নীল */
        .brand-blue {
            background-color: #0d6efd;
            transition: background-color 0.2s;
        }

        .brand-blue:hover {
            background-color: #0b5ed7;
        }

        .brand-blue-text {
            color: #0d6efd;
        }

        /* কার্ড স্টাইল - এলিভেটেড লুক */
        .app-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
            transition: box-shadow 0.3s, transform 0.2s;
        }

        .app-card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        /* টেবিল স্টাইলিং */
        .app-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .app-table th, .app-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap; 
        }

        .app-table thead th {
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 600;
            text-align: left;
            text-transform: uppercase;
            font-size: 0.875rem;
        }

        .app-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* ব্যবহারকারীর বিস্তারিত ড্রপডাউন রো */
        .user-details-row td {
            padding: 0 !important;
            border-bottom: none !important;
        }
        .user-details-content {
            padding: 1.5rem;
            background-color: #fcfdff;
            border-top: 1px solid #e9ecef;
            width: 100%;
        }

        /* কাস্টম মডাল স্টাইল */
        .custom-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            transition: opacity 0.3s ease;
        }
        
        .custom-modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 450px; 
            text-align: center;
            animation: zoomIn 0.3s ease-out;
        }
        
        .custom-modal-actions {
            margin-top: 1.5rem;
            display: flex;
            justify-content: space-around;
            gap: 1rem;
        }
        
        .custom-modal-btn {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 9999px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        
        /* রিপোর্ট কার্ড স্টাইল */
        .report-card {
            background: #fff;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-left: 5px solid #f59e0b;
        }
        
        .report-card.bug { border-left-color: #ef4444; }
        .report-card.suggestion { border-left-color: #3b82f6; }
        .report-card.security { border-left-color: #10b981; }
    </style>
</head>
<body>
    
    <div class="container max-w-6xl mx-auto p-4 md:p-8">
        <header class="app-card p-6 text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center justify-center gap-4">
                <i class="fas fa-tools brand-blue-text"></i>
                এডমিন ড্যাশবোর্ড
            </h1>
        </header>
        
        <div class="app-card p-6">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-xl font-bold text-gray-800 mb-4 md:mb-0">ব্যবস্থাপনা প্যানেল</h2>
                <div class="tabs flex flex-wrap gap-2 md:gap-4">
                    <button class="tab px-4 py-2 rounded-full text-sm font-semibold transition-colors duration-200 bg-blue-600 text-white active" data-tab="users">
                        <i class="fas fa-users mr-2"></i> ব্যবহারকারী
                    </button>
                    <button class="tab px-4 py-2 rounded-full text-sm font-semibold transition-colors duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300" data-tab="tasks">
                        <i class="fas fa-list-check mr-2"></i> কাজসমূহ
                    </button>
                    <button class="tab px-4 py-2 rounded-full text-sm font-semibold transition-colors duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300" data-tab="proofs">
                        <i class="fas fa-file-circle-check mr-2"></i> প্রুফ রিভিউ
                    </button>
                    <!-- রিপোর্ট ট্যাব -->
                    <button class="tab px-4 py-2 rounded-full text-sm font-semibold transition-colors duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300" data-tab="reports">
                        <i class="fas fa-bug mr-2"></i> রিপোর্ট
                    </button>
                    <!-- সেটিংস ট্যাব -->
                    <button class="tab px-4 py-2 rounded-full text-sm font-semibold transition-colors duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300" data-tab="settings">
                        <i class="fas fa-cog mr-2"></i> সেটিংস
                    </button>
                </div>
            </div>

            <div id="users" class="tab-content active">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">ব্যবহারকারী তালিকা</h3>
                <div class="overflow-x-auto">
                    <table class="app-table">
                        <thead>
                            <tr>
                                <th>ইউজার ID</th>
                                <th>নাম</th>
                                <th>ইমেইল</th> <!-- নতুন কলাম -->
                                <th>পয়েন্ট</th>
                                <th>রোল</th>
                                <th class="w-1/4">অ্যাকশন</th> <!-- অ্যাকশন টগল বাটন থাকবে -->
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="tasks" class="tab-content hidden">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4 flex justify-between items-center">
                    কাজসমূহ তালিকা
                    <!-- টাস্ক তৈরির বাটন -->
                    <button class="brand-blue text-white px-4 py-2 rounded-lg text-sm font-bold hover:brightness-110 transition duration-200" onclick="openTaskModal(null)">
                        <i class="fas fa-plus mr-2"></i> নতুন টাস্ক তৈরি করুন
                    </button>
                </h3>
                <div class="overflow-x-auto">
                    <table class="app-table">
                        <thead>
                            <tr>
                                <th>আইডি</th>
                                <th>প্রকার</th>
                                <th>লিংক</th>
                                <th>পয়েন্ট</th>
                                <th>অবস্থা</th>
                                <th>অ্যাকশন</th>
                            </tr>
                        </thead>
                        <tbody id="tasks-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div id="proofs" class="tab-content hidden">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">পর্যালোচনা করার জন্য প্রুফ</h3>
                <div id="proofs-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Proofs will be rendered here -->
                </div>
            </div>
            
            <!-- রিপোর্ট কন্টেন্ট সেকশন -->
            <div id="reports" class="tab-content hidden">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">পর্যালোচনা করার জন্য রিপোর্ট</h3>
                <div id="reports-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Reports will be rendered here -->
                </div>
            </div>
            <!-- রিপোর্ট কন্টেন্ট সেকশন শেষ -->

            <!-- সেটিংস কন্টেন্ট সেকশন -->
            <div id="settings" class="tab-content hidden">
                <h3 class="text-2xl font-semibold text-gray-700 mb-6 text-center">গ্লোবাল কন্ট্রোল সেটিংস</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    
                    <!-- রেফারেল বোনাস সেটিংস -->
                    <div class="p-6 app-card space-y-4">
                        <h4 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4 flex items-center gap-2"><i class="fas fa-share-alt brand-blue-text"></i> রেফারেল বোনাস সেটিংস</h4>
                        
                        <!-- referredUser ইনপুট -->
                        <div>
                            <label for="referredBonus" class="block text-sm font-medium text-gray-700 mb-2">
                                রেফার্ড ইউজার বোনাস (referredUser):
                            </label>
                            <input type="number" id="referredBonus" min="0" class="w-full p-3 border border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="নতুন ইউজার কত পয়েন্ট পাবে">
                        </div>

                        <!-- refereeUser ইনপুট -->
                        <div>
                            <label for="refereeBonus" class="block text-sm font-medium text-gray-700 mb-2">
                                রেফারি ইউজার বোনাস (refereeUser):
                            </label>
                            <input type="number" id="refereeBonus" min="0" class="w-full p-3 border border-green-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="যে রেফার করেছে সে কত পয়েন্ট পাবে">
                        </div>

                        <button id="saveReferralSettingsBtn" class="w-full brand-blue text-white py-3 rounded-lg font-bold hover:brightness-110 transition duration-200">
                            <i class="fas fa-save mr-2"></i> রেফারেল সেটিংস সেভ করুন
                        </button>
                        <p id="referral-status" class="text-center text-sm mt-2 text-gray-500 hidden"></p>
                    </div>

                    <!-- প্রোডাক্ট পয়েন্ট সেটিংস -->
                    <div class="p-6 app-card space-y-4">
                        <h4 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4 flex items-center gap-2"><i class="fas fa-tags text-yellow-600"></i> টাস্ক পয়েন্ট সেটিংস (অর্ডার পেজ)</h4>
                        
                        <p class="text-gray-600 text-sm mb-4">
                            অর্ডার তৈরির সময় প্রতিটি টাস্কের জন্য ডিফল্ট পয়েন্ট এখানে নির্ধারণ করুন। ডেটাবেজ পাথ: <code>controls/productPoints</code>
                        </p>
                        
                        <!-- Product Points Input Group -->
                        <div id="product-points-inputs" class="space-y-4">
                            
                            <!-- 1. react -->
                            <div>
                                <label for="react_points" class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                    <i class="fas fa-thumbs-up text-blue-600"></i> রিয়েক্ট টাস্ক পয়েন্ট (react):
                                </label>
                                <input type="number" id="react_points" min="0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" placeholder="রিয়েক্ট টাস্কের জন্য পয়েন্ট">
                            </div>

                            <!-- 2. Comment -->
                            <div>
                                <label for="comment_points" class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                    <i class="fas fa-comment text-indigo-600"></i> কমেন্ট টাস্ক পয়েন্ট (comment):
                                </label>
                                <input type="number" id="comment_points" min="0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" placeholder="কমেন্ট টাস্কের জন্য পয়েন্ট">
                            </div>

                            <!-- 3. Follow -->
                            <div>
                                <label for="follow_points" class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                    <i class="fas fa-user-plus text-purple-600"></i> ফলো টাস্ক পয়েন্ট (follow):
                                </label>
                                <input type="number" id="follow_points" min="0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" placeholder="ফলো টাস্কের জন্য পয়েন্ট">
                            </div>

                            <!-- 4. Share -->
                            <div>
                                <label for="share_points" class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                    <i class="fas fa-share-alt text-cyan-600"></i> শেয়ার টাস্ক পয়েন্ট (share):
                                </label>
                                <input type="number" id="share_points" min="0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" placeholder="শেয়ার টাস্কের জন্য পয়েন্ট">
                            </div>

                            <!-- 5. Group Join -->
                            <div>
                                <label for="group_join_points" class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                    <i class="fas fa-users text-teal-600"></i> গ্রুপ জয়েন টাস্ক পয়েন্ট (groupJoin):
                                </label>
                                <input type="number" id="group_join_points" min="0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" placeholder="গ্রুপ জয়েন টাস্কের জন্য পয়েন্ট">
                            </div>

                        </div>

                        <button id="saveProductPointsBtn" class="w-full bg-yellow-600 text-white py-3 rounded-lg font-bold hover:bg-yellow-700 transition duration-200">
                            <i class="fas fa-save mr-2"></i> টাস্ক পয়েন্ট সেভ করুন
                        </button>
                        <p id="product-status" class="text-center text-sm mt-2 text-gray-500 hidden"></p>
                    </div>
                </div>
            </div>
            <!-- সেটিংস কন্টেন্ট সেকশন শেষ -->

        </div>
    </div>
    
    <!-- কাস্টম কনফার্মেশন মডাল -->
    <div id="admin-modal" class="custom-modal">
        <div class="custom-modal-content">
            <h3 class="text-xl font-bold mb-2 text-gray-800" id="modal-title">নিশ্চিত করুন</h3>
            <p class="text-gray-600 mb-4" id="modal-message"></p>
            
            <!-- সাধারণ রিভিউ মন্তব্য ইনপুট (প্রুফ/রিপোর্ট উভয়ের জন্য) -->
            <div id="review-comment-group" class="mb-4 hidden text-left">
                <label for="review-comment" class="block text-sm font-medium text-gray-700 mb-2" id="review-comment-label">মন্তব্য/কারণ:</label>
                <textarea id="review-comment" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="এডমিন মন্তব্য/বাতিলের কারণ লিখুন..."></textarea>
            </div>
            
            <!-- পুরস্কারের পয়েন্ট ইনপুট (রিপোর্ট ম্যানেজমেন্টের জন্য) -->
            <div id="reward-points-group" class="mb-4 hidden text-left">
                <label for="reward-points" class="block text-sm font-medium text-gray-700 mb-2">পুরস্কার পয়েন্ট (৫০-৫০০):</label>
                <input type="number" id="reward-points" min="50" max="500" value="100" class="w-full p-3 border border-green-300 rounded-lg focus:ring-green-500 focus:border-green-500">
            </div>

            <!-- সাসপেনশন ইনপুট গ্রুপ -->
            <div id="suspension-group" class="mb-4 hidden text-left space-y-3">
                <p class="text-lg font-bold text-red-600 border-b pb-2">ইউজার সাসপেন্ড করুন</p>
                <div class="flex flex-col sm:flex-row gap-3">
                    <div class="flex-1">
                        <label for="suspend-duration" class="block text-sm font-medium text-gray-700 mb-1">সময়সীমা:</label>
                        <select id="suspend-duration" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                            <option value="60">১ ঘন্টা</option>
                            <option value="180">৩ ঘন্টা</option>
                            <option value="360">৬ ঘন্টা</option>
                            <option value="720">১২ ঘন্টা</option>
                            <option value="1440" selected>১ দিন (২৪ ঘন্টা)</option>
                            <option value="4320">৩ দিন</option>
                            <option value="10080">৭ দিন</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="suspend-reason" class="block text-sm font-medium text-gray-700 mb-1">কারণ (আবশ্যক):</label>
                        <textarea id="suspend-reason" rows="3" class="w-full p-3 border border-red-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="সাসপেন্ড করার কারণ লিখুন..."></textarea>
                    </div>
                </div>
            </div>
            
            <!-- পয়েন্ট অ্যাডজাস্টমেন্ট ইনপুট গ্রুপ -->
            <div id="point-adjustment-group" class="mb-4 hidden text-left space-y-3">
                <p class="text-lg font-bold text-yellow-600 border-b pb-2">পয়েন্ট অ্যাডজাস্ট করুন</p>
                <div>
                    <label for="adjustment-amount" class="block text-sm font-medium text-gray-700 mb-1">পয়েন্ট পরিবর্তন (+/-):</label>
                    <input type="number" id="adjustment-amount" class="w-full p-3 border border-yellow-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" placeholder="+100 বা -500 লিখুন" required>
                </div>
                <div>
                    <label for="adjustment-reason" class="block text-sm font-medium text-gray-700 mb-1">কারণ (আবশ্যক):</label>
                    <textarea id="adjustment-reason" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" placeholder="পরিবর্তনের কারণ লিখুন..."></textarea>
                </div>
            </div>


            <div class="custom-modal-actions">
                <button class="custom-modal-btn bg-red-500 text-white hover:bg-red-600" id="modal-confirm-btn">
                    নিশ্চিত করুন
                </button>
                <button class="custom-modal-btn bg-gray-200 text-gray-800 hover:bg-gray-300" onclick="closeAdminModal()">
                    বাতিল
                </button>
            </div>
        </div>
    </div>
    
    <!-- টাস্ক তৈরি/এডিট করার মডাল -->
    <div id="task-modal" class="custom-modal">
        <div class="custom-modal-content max-w-lg">
            <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2" id="task-modal-title">নতুন টাস্ক তৈরি করুন</h3>
            <form id="task-form" class="space-y-4 text-left">
                <input type="hidden" id="task-id">
                
                <div>
                    <label for="task-link" class="block text-sm font-medium text-gray-700 mb-1">টাস্ক লিংক (আবশ্যক):</label>
                    <input type="url" id="task-link" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="ফেসবুক বা অন্য কোনো লিংকের URL" required>
                </div>
                
                <div>
                    <label for="task-type" class="block text-sm font-medium text-gray-700 mb-1">টাস্ক প্রকার (আবশ্যক):</label>
                    <select id="task-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="">একটি প্রকার নির্বাচন করুন</option>
                        <option value="react">রিয়েক্ট (React)</option>
                        <option value="comment">কমেন্ট (Comment)</option>
                        <option value="follow">ফলো (Follow)</option>
                        <option value="share">শেয়ার (Share)</option>
                        <option value="groupJoin">গ্রুপ জয়েন (Group Join)</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="task-quantity" class="block text-sm font-medium text-gray-700 mb-1">মোট পরিমাণ (আবশ্যক):</label>
                        <input type="number" id="task-quantity" min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="মোট কতজন ইউজার দরকার" required>
                    </div>
                    <div>
                        <label for="task-points" class="block text-sm font-medium text-gray-700 mb-1">প্রতি টাস্কে পয়েন্ট (ঐচ্ছিক):</label>
                        <input type="number" id="task-points" min="0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="যদি ডিফল্ট সেটিং ব্যবহার না করতে চান">
                        <p class="text-xs text-gray-500 mt-1">যদি খালি রাখা হয়, তবে সেটিংসের ডিফল্ট মান ব্যবহার করা হবে।</p>
                    </div>
                </div>

                <div class="custom-modal-actions pt-4">
                    <button type="submit" class="custom-modal-btn brand-blue text-white hover:brightness-110" id="task-save-btn">
                        <i class="fas fa-save mr-2"></i> টাস্ক সেভ করুন
                    </button>
                    <button type="button" class="custom-modal-btn bg-gray-200 text-gray-800 hover:bg-gray-300" onclick="closeTaskModal()">
                        বাতিল
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- টাস্ক মডাল শেষ -->

    <div id="notification-container"></div>
    
    <script type="module">
        // Firebase imports from rtdb-config.js
        import { rtdb, ref, onValue, set, update, remove, get, auth, showNotification, runTransaction, push } from './rtdb-config.js'; 
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js"; 

        // Get references to the DOM elements
        const usersTableBody = document.querySelector('#users table tbody');
        const tasksTableBody = document.querySelector('#tasks table tbody');
        const proofsGrid = document.getElementById('proofs-grid');
        const reportsGrid = document.getElementById('reports-grid'); 
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        const adminModal = document.getElementById('admin-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        
        // সাধারণ রিভিউ মন্তব্য ইনপুট
        const reviewCommentGroup = document.getElementById('review-comment-group');
        const reviewCommentInput = document.getElementById('review-comment');
        const reviewCommentLabel = document.getElementById('review-comment-label');
        
        const rewardPointsGroup = document.getElementById('reward-points-group');
        const rewardPointsInput = document.getElementById('reward-points');

        // সাসপেনশন ইনপুট এলিমেন্ট
        const suspensionGroup = document.getElementById('suspension-group');
        const suspendDurationInput = document.getElementById('suspend-duration');
        const suspendReasonInput = document.getElementById('suspend-reason');
        
        // পয়েন্ট অ্যাডজাস্টমেন্ট ইনপুট এলিমেন্ট
        const pointAdjustmentGroup = document.getElementById('point-adjustment-group');
        const adjustmentAmountInput = document.getElementById('adjustment-amount');
        const adjustmentReasonInput = document.getElementById('adjustment-reason');

        // সেটিংস ইনপুট এলিমেন্ট (Referral)
        const referredBonusInput = document.getElementById('referredBonus');
        const refereeBonusInput = document.getElementById('refereeBonus');
        const saveReferralSettingsBtn = document.getElementById('saveReferralSettingsBtn');
        const referralStatus = document.getElementById('referral-status');

        // সেটিংস ইনপুট এলিমেন্ট (Task Points)
        const reactPointsInput = document.getElementById('react_points');
        const commentPointsInput = document.getElementById('comment_points');
        const followPointsInput = document.getElementById('follow_points');
        const sharePointsInput = document.getElementById('share_points');
        const groupJoinPointsInput = document.getElementById('group_join_points');
        const saveProductPointsBtn = document.getElementById('saveProductPointsBtn');
        const productStatus = document.getElementById('product-status');

        // টাস্ক মডাল এলিমেন্ট
        const taskModal = document.getElementById('task-modal');
        const taskModalTitle = document.getElementById('task-modal-title');
        const taskIdInput = document.getElementById('task-id');
        const taskLinkInput = document.getElementById('task-link');
        const taskTypeInput = document.getElementById('task-type');
        const taskQuantityInput = document.getElementById('task-quantity');
        const taskPointsInput = document.getElementById('task-points');
        const taskForm = document.getElementById('task-form');


        let currentUserId = null;
        let pendingAction = { actionType: null, data: null };
        let allUsersData = {}; // সমস্ত ইউজার ডেটা ক্যাশ করে রাখা

        // Modal functions
        window.closeAdminModal = () => {
            adminModal.style.display = 'none';
            pendingAction = { actionType: null, data: null }; // রিসেট
            reviewCommentInput.value = ''; // ইনপুট ক্লিয়ার করা
            rewardPointsInput.value = '100'; // রিওয়ার্ড ইনপুট ডিফল্ট করা
            suspendReasonInput.value = ''; // সাসপেন্ড কারণ ক্লিয়ার করা
            
            // পয়েন্ট অ্যাডজাস্টমেন্ট ইনপুট রিসেট করা
            pointAdjustmentGroup.classList.add('hidden'); 
            adjustmentAmountInput.value = '';
            adjustmentReasonInput.value = '';
        };
        
        const openAdminModal = (type, data) => {
            pendingAction.actionType = type;
            pendingAction.data = data;
            
            let titleText = 'নিশ্চিত করুন';
            let messageText = '';
            let confirmClass = '';
            
            // সব লুকানো ইনপুট হাইড করুন এবং বর্ডার রিসেট করুন
            reviewCommentGroup.classList.add('hidden');
            rewardPointsGroup.classList.add('hidden'); 
            suspensionGroup.classList.add('hidden'); 
            pointAdjustmentGroup.classList.add('hidden'); 
            reviewCommentInput.classList.remove('border-red-500', 'focus:ring-red-500', 'focus:border-red-500'); 
            reviewCommentInput.classList.add('border-gray-300', 'focus:ring-blue-500', 'focus:border-blue-500');

            if (type === 'closeTask') {
                titleText = 'কাজ বন্ধ করুন';
                messageText = `আপনি কি নিশ্চিত টাস্ক ID ${data.taskId.substring(0, 8)}... স্থায়ীভাবে বন্ধ করতে চান?`;
                confirmClass = 'bg-red-500 hover:bg-red-600';
            } else if (type === 'approveProof') {
                titleText = 'অনুমোদন দিন';
                messageText = `আপনি কি নিশ্চিত প্রুফটি অনুমোদন করে ইউজারকে ${(data.points).toLocaleString('bn-BD')} পয়েন্ট দিতে চান?`;
                confirmClass = 'bg-green-500 hover:bg-green-600';
            } else if (type === 'rejectProof') {
                titleText = 'বাতিল করুন';
                messageText = `আপনি কি নিশ্চিত প্রুফটি বাতিল করবেন? ইউজার আবার চেষ্টা করতে পারবে। বাতিলের কারণ উল্লেখ করুন।`;
                confirmClass = 'bg-red-500 hover:bg-red-600';
                reviewCommentGroup.classList.remove('hidden'); 
                reviewCommentLabel.textContent = 'বাতিলের কারণ (আবশ্যক):';
                reviewCommentInput.value = ''; 
                reviewCommentInput.classList.remove('border-gray-300', 'focus:ring-blue-500', 'focus:border-blue-500');
                reviewCommentInput.classList.add('border-red-500', 'focus:ring-red-500', 'focus:border-red-500'); 
            } else if (type === 'approveReport') { 
                titleText = 'রিপোর্ট পুরস্কার দিন';
                messageText = `আপনি কি নিশ্চিত ইউজার ${data.userName} কে পুরস্কার পয়েন্ট দিতে চান? রিপোর্টটি: "${data.title}"`;
                confirmClass = 'bg-green-500 hover:bg-green-600';
                rewardPointsGroup.classList.remove('hidden'); 
                reviewCommentGroup.classList.remove('hidden'); 
                reviewCommentLabel.textContent = 'এডমিন মন্তব্য (ঐচ্ছিক):';
                reviewCommentInput.placeholder = 'এই রিপোর্ট সম্পর্কে আপনার মন্তব্য লিখুন...';
                reviewCommentInput.value = ''; 
                rewardPointsInput.value = '100'; 
            } else if (type === 'rejectReport') { 
                titleText = 'রিপোর্ট বাতিল করুন';
                messageText = `আপনি কি নিশ্চিত রিপোর্টটি বাতিল করবেন? এটি কোনো পুরস্কার পাবে না। বাতিলের কারণ উল্লেখ করুন।`;
                confirmClass = 'bg-red-500 hover:bg-red-600';
                reviewCommentGroup.classList.remove('hidden'); 
                reviewCommentLabel.textContent = 'বাতিলের কারণ (আবশ্যক):';
                reviewCommentInput.value = ''; 
                reviewCommentInput.classList.remove('border-gray-300', 'focus:ring-blue-500', 'focus:border-blue-500');
                reviewCommentInput.classList.add('border-red-500', 'focus:ring-red-500', 'focus:border-red-500'); 
            } else if (type === 'suspendUser') { 
                titleText = 'ইউজার সাসপেন্ড করুন';
                messageText = `আপনি কি নিশ্চিত ইউজার ID ${data.userId.substring(0, 8)}... কে সাসপেন্ড করতে চান?`;
                confirmClass = 'bg-red-500 hover:bg-red-600';
                suspensionGroup.classList.remove('hidden'); 
                suspendDurationInput.value = '1440'; 
                suspendReasonInput.value = '';
            } else if (type === 'unsuspendUser') { 
                titleText = 'সাসপেন্ড প্রত্যাহার';
                messageText = `আপনি কি নিশ্চিত ইউজার ID ${data.userId.substring(0, 8)}... এর সাসপেনশন প্রত্যাহার করতে চান?`;
                confirmClass = 'bg-green-500 hover:bg-green-600';
            } else if (type === 'adjustPoints') { 
                titleText = 'পয়েন্ট পরিবর্তন করুন';
                modalMessage.innerHTML = `আপনি ইউজার <strong>${data.userName}</strong> এর বর্তমান পয়েন্ট <strong>${(data.currentPoints).toLocaleString('bn-BD')}</strong> পরিবর্তন করতে চান। (+/- মান লিখুন)`;
                confirmClass = 'bg-yellow-500 hover:bg-yellow-600';
                pointAdjustmentGroup.classList.remove('hidden'); 
                adjustmentAmountInput.value = '';
                adjustmentReasonInput.value = '';
            }

            modalConfirmBtn.classList.remove('bg-red-500', 'bg-green-500', 'bg-yellow-500', 'hover:bg-red-600', 'hover:bg-green-600', 'hover:bg-yellow-600');
            const classArray = confirmClass.split(' ');
            modalConfirmBtn.classList.add(...classArray);
            
            modalTitle.textContent = titleText;
            if(type !== 'adjustPoints') {
                modalMessage.textContent = messageText;
            }
            modalConfirmBtn.className = `custom-modal-btn text-white font-bold ${confirmClass}`;
            adminModal.style.display = 'flex';
        };

        // মডাল কনফার্ম বাটনে ক্লিক ইভেন্ট হ্যান্ডলার
        modalConfirmBtn.onclick = () => {
            const { actionType, data } = pendingAction;
            
            if (!currentUserId) {
                showNotification('ত্রুটি: আপনার এডমিন আইডি পাওয়া যায়নি। লগইন করে আবার চেষ্টা করুন।', 'error');
                return;
            }
            
            if (actionType === 'suspendUser') {
                const durationMinutes = parseInt(suspendDurationInput.value);
                const reason = suspendReasonInput.value.trim();
                
                if (isNaN(durationMinutes) || durationMinutes <= 0) {
                    showNotification('সাসপেনশনের সময়সীমা নির্বাচন করুন।', 'error');
                    return;
                }
                if (!reason) {
                    showNotification('সাসপেন্ড করার কারণ লেখা আবশ্যক।', 'error');
                    return;
                }
                window.handleManualSuspension(data.userId, durationMinutes, reason);
            }
            
            else if (actionType === 'adjustPoints') {
                const adjustmentAmount = parseInt(adjustmentAmountInput.value);
                const reason = adjustmentReasonInput.value.trim();
                
                if (isNaN(adjustmentAmount) || adjustmentAmount === 0) {
                    showNotification('পয়েন্টের সঠিক পরিমাণ লিখুন (+ বা -)।', 'error');
                    return;
                }
                if (!reason) {
                    showNotification('পয়েন্ট পরিবর্তনের কারণ লেখা আবশ্যক।', 'error');
                    return;
                }
                window.handlePointAdjustment(data.userId, data.userName, adjustmentAmount, reason);
            }
            
            else if (actionType === 'unsuspendUser') {
                window.handleUnsuspendUser(data.userId);
            }
            
            else if (actionType === 'rejectProof') {
                 const rejectionReason = reviewCommentInput.value.trim();
                 if (!rejectionReason) {
                     showNotification('প্রুফ বাতিল করার জন্য কারণ উল্লেখ করা আবশ্যক।', 'error');
                     return;
                 }
                 window.handleRejectProof(data.taskId, data.proofId, data.userId, rejectionReason);
            } 
            
            else if (actionType === 'approveReport') {
                const rewardPoints = parseInt(rewardPointsInput.value);
                const reviewComment = reviewCommentInput.value.trim(); 
                if (isNaN(rewardPoints) || rewardPoints < 50 || rewardPoints > 500) {
                    showNotification('পুরস্কার পয়েন্টের পরিমাণ ৫০ থেকে ৫০০ এর মধ্যে হতে হবে।', 'error');
                    return;
                }
                window.handleApproveReport(data.reportId, data.userId, rewardPoints, reviewComment);
            }
            
            else if (actionType === 'rejectReport') {
                const reviewComment = reviewCommentInput.value.trim();
                if (!reviewComment) {
                     showNotification('রিপোর্ট বাতিল করার জন্য কারণ উল্লেখ করা আবশ্যক।', 'error');
                     return;
                }
                window.handleRejectReport(data.reportId, reviewComment);
            }
            
            else if (actionType === 'closeTask') {
                window.handleCloseTask(data.taskId);
            } else if (actionType === 'approveProof') {
                window.handleApproveProof(data.taskId, data.proofId, data.userId, data.points); 
            }
            
            closeAdminModal(); 
        };

        window.onclick = function(event) {
            if (event.target === adminModal) {
                closeAdminModal();
            }
            // টাস্ক মডাল বন্ধ করার লজিক
            if (event.target === taskModal) {
                closeTaskModal();
            }
        };

        // টাস্ক মডাল ফাংশন
        window.closeTaskModal = () => {
            taskModal.style.display = 'none';
            taskForm.reset();
            taskIdInput.value = '';
        };

        window.openTaskModal = (task = null) => {
            taskForm.reset();
            taskIdInput.value = '';

            if (task) {
                taskModalTitle.textContent = 'টাস্ক এডিট করুন';
                taskIdInput.value = task.id;
                taskLinkInput.value = task.taskLink || '';
                taskTypeInput.value = task.taskType || '';
                taskQuantityInput.value = task.quantity || 1;
                // Edit mode: only set points if it overrides the default setting
                taskPointsInput.value = task.pointsPerTask !== undefined ? task.pointsPerTask : ''; 
            } else {
                taskModalTitle.textContent = 'নতুন টাস্ক তৈরি করুন';
            }
            taskModal.style.display = 'flex';
        };

        // Event listener for form submission
        taskForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleSaveTask();
        });

        // টাস্ক সেভ (তৈরি/এডিট) করার ফাংশন
        const handleSaveTask = async () => {
            const taskId = taskIdInput.value.trim();
            const taskLink = taskLinkInput.value.trim();
            const taskType = taskTypeInput.value.trim();
            const quantity = parseInt(taskQuantityInput.value);
            // যদি ইনপুট খালি থাকে, তবে undefined ব্যবহার করা হবে, যাতে ডিফল্ট পয়েন্ট ব্যবহার হয়
            const pointsPerTask = taskPointsInput.value.trim() === '' ? undefined : parseInt(taskPointsInput.value); 

            if (!taskLink || !taskType || isNaN(quantity) || quantity < 1) {
                showNotification('ফর্মের সব আবশ্যক ঘর পূরণ করুন।', 'error');
                return;
            }
            if (pointsPerTask !== undefined && (isNaN(pointsPerTask) || pointsPerTask < 0)) {
                showNotification('পয়েন্টের মান অবশ্যই শূন্য বা তার বেশি হতে হবে।', 'error');
                return;
            }
            if (!currentUserId) { showNotification('ত্রুটি: এডমিন আইডি পাওয়া যায়নি।', 'error'); return; }

            showNotification(taskId ? 'টাস্ক আপডেট করা হচ্ছে...' : 'নতুন টাস্ক তৈরি করা হচ্ছে...', 'info');

            const taskData = {
                taskLink: taskLink,
                taskType: taskType,
                quantity: quantity,
                pointsPerTask: pointsPerTask, 
                status: 'active', // নতুন টাস্ক সক্রিয় থাকবে
                updatedBy: currentUserId,
                updatedAt: Date.now()
            };
            
            if (!taskId) {
                // নতুন টাস্ক তৈরি করা
                taskData.createdBy = currentUserId;
                taskData.createdAt = Date.now();
            }

            try {
                if (taskId) {
                    // টাস্ক এডিট করা
                    const taskRef = ref(rtdb, `tasks/${taskId}`);
                    // যদি pointsPerTask undefined হয়, তবে আপডেট পেলোড থেকে এটিকে বাদ দিন যাতে এটি বিদ্যমান মানকে ওভাররাইড না করে
                    if (pointsPerTask === undefined) { delete taskData.pointsPerTask; }
                    await update(taskRef, taskData);
                    showNotification('সফলভাবে টাস্ক আপডেট করা হয়েছে।', 'success', 5000);
                } else {
                    // নতুন টাস্ক যোগ করা
                    const tasksRef = ref(rtdb, 'tasks');
                    await push(tasksRef, taskData);
                    showNotification('সফলভাবে নতুন টাস্ক তৈরি করা হয়েছে।', 'success', 5000);
                }
                closeTaskModal();
            } catch (error) {
                console.error("Error saving task:", error);
                showNotification('টাস্ক সেভ করতে ব্যর্থ: ডেটাবেজ ত্রুটি।', 'error');
            }
        };


        // End Modal functions

        /**
         * এডমিন রোল চেক করা এবং অনুমোদন না পেলে রিডাইরেক্ট করা।
         */
        const checkAdminRole = (userId) => {
             const userRef = ref(rtdb, `users/${userId}/role`);
             onValue(userRef, (snapshot) => {
                 const role = snapshot.val();
                 if (role !== 'admin') {
                     showNotification("অনুমতি নেই! শুধু এডমিনরাই এই পেজে প্রবেশ করতে পারে।", 'error');
                     setTimeout(() => { window.location.href = 'index.html'; }, 1500);
                 } else {
                    startDataListeners();
                 }
             }, { onlyOnce: true });
        };
        
        // AUTH CHECK 
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                checkAdminRole(currentUserId);
            } else {
                window.location.href = 'login.html';
            }
        });

        const startDataListeners = () => {
            // Listen for users data and cache it
            onValue(ref(rtdb, 'users'), (snapshot) => {
                const users = snapshot.val() || {};
                allUsersData = users; 
                renderUsers(users); 
            });

            // Listen for tasks data
            onValue(ref(rtdb, 'tasks'), (snapshot) => {
                const tasks = snapshot.val() || {};
                renderTasks(tasks);
                renderProofs(tasks); 
            });
            
            // রিপোর্ট ডেটা লিসেন করা
            onValue(ref(rtdb, 'reports'), (snapshot) => {
                const reports = snapshot.val() || {};
                renderReports(reports); 
            });
            
            // সেটিংস লিসেন করা
            loadControlSettings(); 
        };
        
        // কন্ট্রোল সেটিংস লোড করার ফাংশন
        const loadControlSettings = () => {
            // রেফারেল সেটিংস লোড করা
            const referralRef = ref(rtdb, 'controls/referralBonus');
            onValue(referralRef, (snapshot) => {
                const controlData = snapshot.val() || {};
                referredBonusInput.value = controlData.referredUser || 0;
                refereeBonusInput.value = controlData.refereeUser || 0;
                referralStatus.textContent = `সর্বশেষ আপডেট: ${new Date().toLocaleTimeString('bn-BD')}`;
                referralStatus.classList.remove('hidden');
            });
            
            // প্রোডাক্ট পয়েন্ট সেটিংস লোড করা
            const productRef = ref(rtdb, 'controls/productPoints');
            onValue(productRef, (snapshot) => {
                const productData = snapshot.val() || {};
                reactPointsInput.value = productData.react || 0;
                commentPointsInput.value = productData.comment || 0;
                followPointsInput.value = productData.follow || 0;
                sharePointsInput.value = productData.share || 0;
                groupJoinPointsInput.value = productData.groupJoin || 0;
                productStatus.textContent = `সর্বশেষ আপডেট: ${new Date().toLocaleTimeString('bn-BD')}`;
                productStatus.classList.remove('hidden');
            });
        };

        // রেফারেল কন্ট্রোল সেটিংস সেভ করার ফাংশন
        const handleSaveReferralSettings = async () => {
            const referredValue = parseInt(referredBonusInput.value) || 0;
            const refereeValue = parseInt(refereeBonusInput.value) || 0;
            
            if (referredValue < 0 || refereeValue < 0) {
                showNotification('রেফারেল পয়েন্টের মান অবশ্যই শূন্য বা তার বেশি হতে হবে।', 'error');
                return;
            }
            if (!currentUserId) { showNotification('ত্রুটি: এডমিন আইডি পাওয়া যায়নি।', 'error'); return; }
            showNotification('রেফারেল সেটিংস সেভ করা হচ্ছে...', 'info');
            const controlRef = ref(rtdb, 'controls/referralBonus');
            try {
                await update(controlRef, {
                    referredUser: referredValue,
                    refereeUser: refereeValue,
                    lastUpdatedBy: currentUserId,
                    lastUpdatedAt: Date.now()
                });
                showNotification('সফলভাবে রেফারেল সেটিংস সেভ করা হয়েছে।', 'success', 5000);
            } catch (error) {
                console.error("Error saving referral settings:", error);
                showNotification('রেফারেল সেটিংস সেভ করতে ব্যর্থ: ডেটাবেজ ত্রুটি।', 'error');
            }
        };

        // প্রোডাক্ট পয়েন্ট সেটিংস সেভ করার ফাংশন
        const handleSaveProductPoints = async () => {
            const reactValue = parseInt(reactPointsInput.value) || 0;
            const commentValue = parseInt(commentPointsInput.value) || 0;
            const followValue = parseInt(followPointsInput.value) || 0;
            const shareValue = parseInt(sharePointsInput.value) || 0;
            const groupJoinValue = parseInt(groupJoinPointsInput.value) || 0;
            
            if (reactValue < 0 || commentValue < 0 || followValue < 0 || shareValue < 0 || groupJoinValue < 0) {
                showNotification('টাস্ক পয়েন্টের মান অবশ্যই শূন্য বা তার বেশি হতে হবে।', 'error');
                return;
            }
            if (!currentUserId) { showNotification('ত্রুটি: এডমিন আইডি পাওয়া যায়নি।', 'error'); return; }
            showNotification('টাস্ক পয়েন্ট সেভ করা হচ্ছে...', 'info');
            const productPointsRef = ref(rtdb, 'controls/productPoints');
            try {
                await update(productPointsRef, {
                    react: reactValue, comment: commentValue, follow: followValue, 
                    share: shareValue, groupJoin: groupJoinValue,
                    lastUpdatedBy: currentUserId, lastUpdatedAt: Date.now()
                });
                showNotification('সফলভাবে টাস্ক পয়েন্ট সেভ করা হয়েছে।', 'success', 5000);
            } catch (error) {
                console.error("Error saving product points:", error);
                showNotification('টাস্ক পয়েন্ট সেভ করতে ব্যর্থ: ডেটাবেজ ত্রুটি।', 'error');
            }
        };

        // ইউজার প্রোফাইল এডিট ফর্ম তৈরি করার ফাংশন (আপডেট করা হয়েছে: অ্যাকশন বাটন যুক্ত করা হয়েছে)
        const generateProfileEditForm = (user) => {
            const userId = user.uid;
            const displayName = user.facebookName || 'N/A';
            const currentPoints = user.points || 0;
            const isVerified = user.isVerified || false;
            const isSuspended = user.suspension?.suspended && user.suspension.suspendUntil > Date.now();

            // 1. অ্যাকশন বাটন তৈরি করা
            const verificationButton = `
                <button class="w-full sm:w-auto px-4 py-2 rounded-lg text-sm font-bold text-white transition-colors duration-200 ${isVerified ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'}" 
                    onclick="toggleVerification('${userId}', ${isVerified})" 
                    title="${isVerified ? 'ভেরিফিকেশন স্ট্যাটাস বাতিল করুন' : 'ইউজারকে ভেরিফাই করুন'}">
                    <i class="fas ${isVerified ? 'fa-ban' : 'fa-user-check'} mr-2"></i>
                    ${isVerified ? 'ভেরিফিকেশন বাতিল' : 'ইউজারকে ভেরিফাই করুন'}
                </button>
            `;
            
            const suspensionActionHtml = isSuspended ? `
                <button class="w-full sm:w-auto px-4 py-2 rounded-lg text-sm font-bold text-white transition-colors duration-200 bg-green-500 hover:bg-green-600" 
                    onclick="openAdminModal('unsuspendUser', { userId: '${userId}', userName: '${displayName}' })" 
                    title="সাসপেনশন প্রত্যাহার করুন">
                    <i class="fas fa-undo mr-2"></i> সাসপেনশন বাদ দিন
                </button>
            ` : `
                <button class="w-full sm:w-auto px-4 py-2 rounded-lg text-sm font-bold text-white transition-colors duration-200 bg-red-600 hover:bg-red-700" 
                    onclick="openAdminModal('suspendUser', { userId: '${userId}', userName: '${displayName}' })" 
                    title="নির্দিষ্ট সময়ের জন্য সাসপেন্ড করুন">
                    <i class="fas fa-gavel mr-2"></i> ইউজার সাসপেন্ড করুন
                </button>
            `;
            
            const pointAdjustButton = `
                <button class="w-full sm:w-auto px-4 py-2 rounded-lg text-sm font-bold text-white transition-colors duration-200 bg-yellow-500 hover:bg-yellow-600" 
                    onclick="openAdminModal('adjustPoints', { userId: '${userId}', userName: '${displayName}', currentPoints: ${currentPoints} })" 
                    title="পয়েন্ট বাড়ান বা কমান">
                    <i class="fas fa-coins mr-2"></i> পয়েন্ট অ্যাডজাস্ট
                </button>
            `;

            const actionsSection = `
                <div class="mb-6 pb-4 border-b border-gray-200">
                    <h4 class="text-xl font-bold text-gray-800 mb-4">অ্যাডমিন অ্যাকশনসমূহ</h4>
                    <div class="flex flex-wrap gap-3">
                        ${pointAdjustButton}
                        ${suspensionActionHtml}
                        ${verificationButton}
                    </div>
                </div>
            `;
            
            // 2. প্রোফাইল ডেটা তৈরি করা
            const userProperties = {};
            for (const key in user) {
                // অবজেক্ট বা অ্যারেকে স্ট্রিংফাইড JSON হিসেবে দেখাতে হবে
                if (typeof user[key] === 'object' && user[key] !== null) {
                    userProperties[key] = JSON.stringify(user[key], null, 2);
                } else {
                    userProperties[key] = user[key];
                }
            }

            // যে কীগুলো এডিট করা যাবে না
            const nonEditableKeys = ['uid', 'facebookName', 'email', 'createdAt', 'lastLoginAt', 'suspension'];

            let formHtml = `
                <h4 class="text-xl font-bold text-gray-800 mb-4 pt-4 border-t border-gray-200">প্রোফাইল ডেটা এডিট</h4>
                <form onsubmit="event.preventDefault(); handleProfileUpdate('${userId}');" id="profile-form-${userId}" class="grid grid-cols-1 md:grid-cols-2 gap-4">`;

            for (const key in userProperties) {
                const isEditable = !nonEditableKeys.includes(key);
                const value = userProperties[key];

                const inputId = `edit-${userId}-${key}`;
                const labelText = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()); // camelCase কে স্পেস সহ Capitalize করা

                if (key === 'role') {
                    // রোলের জন্য ড্রপডাউন
                    formHtml += `
                        <div class="space-y-1">
                            <label for="${inputId}" class="block text-sm font-medium text-gray-700">${labelText}:</label>
                            <select id="${inputId}" class="w-full p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 ${isEditable ? 'bg-white border-blue-300' : 'bg-gray-100 border-gray-300'}">
                                <option value="user" ${value === 'user' ? 'selected' : ''}>User</option>
                                <option value="moderator" ${value === 'moderator' ? 'selected' : ''}>Moderator</option>
                                <option value="admin" ${value === 'admin' ? 'selected' : ''}>Admin</option>
                            </select>
                        </div>
                    `;
                } else {
                    // অন্যান্য ফিল্ডের জন্য টেক্সট ইনপুট
                    formHtml += `
                        <div class="space-y-1">
                            <label for="${inputId}" class="block text-sm font-medium text-gray-700">${labelText}:</label>
                            <input 
                                type="text" 
                                id="${inputId}" 
                                value="${value}" 
                                ${isEditable ? '' : 'readonly'}
                                class="w-full p-2 border rounded-lg ${isEditable ? 'bg-white border-green-300 focus:ring-green-500 focus:border-green-500' : 'bg-gray-100 text-gray-600 border-gray-300'}"
                            >
                        </div>
                    `;
                }
            }

            formHtml += `
                </form>
                <div class="col-span-full pt-6">
                    <button onclick="handleProfileUpdate('${userId}')" class="w-full brand-blue text-white py-3 rounded-lg font-bold hover:brightness-110 transition duration-200">
                        <i class="fas fa-save mr-2"></i> প্রোফাইল ডেটা সেভ করুন
                    </button>
                </div>
            `;

            return actionsSection + formHtml;
        };

        // প্রোফাইল ডেটা আপডেট করার ফাংশন
        window.handleProfileUpdate = async (userId) => {
            const form = document.getElementById(`profile-form-${userId}`);
            if (!form) return;

            showNotification('প্রোফাইল ডেটা সেভ করা হচ্ছে...', 'info');

            const updates = {};
            const children = form.querySelectorAll('div > *[id]');
            
            // যে কীগুলো এডিট করা যাবে না
            const nonEditableKeys = ['uid', 'facebookName', 'email', 'createdAt', 'lastLoginAt', 'suspension'];

            children.forEach(input => {
                const key = input.id.replace(`edit-${userId}-`, '');
                
                // এডিট করা যাবে না এমন কী বাদ দেওয়া
                if (nonEditableKeys.includes(key)) return; 
                
                let value = input.value;
                
                // যদি এটি JSON স্ট্রিং ছিল, তবে পার্স করার চেষ্টা করুন (যেমন: array, object)
                if (value.startsWith('{') || value.startsWith('[')) {
                    try {
                        value = JSON.parse(value);
                    } catch (e) {
                        showNotification(`ত্রুটি: ${key} ফিল্ডে অবৈধ JSON ডেটা।`, 'error');
                        return; // অবৈধ JSON হলে আপডেট থামানো
                    }
                } else if (key === 'points' || key === 'trustScore' || key === 'tasksCompleted') {
                    // সংখ্যাকে ইন্টিজারে রূপান্তর করা
                    value = parseInt(value) || 0;
                }
                
                updates[key] = value;
            });
            
            if (Object.keys(updates).length === 0) {
                 showNotification('কোনো পরিবর্তন পাওয়া যায়নি বা সব ফিল্ড এডিট করা যায় না।', 'info');
                 return;
            }

            const userRef = ref(rtdb, `users/${userId}`);
            try {
                await update(userRef, updates);
                showNotification('সফলভাবে ইউজার প্রোফাইল আপডেট করা হয়েছে!', 'success', 5000);
            } catch (error) {
                console.error("Error updating user profile:", error);
                showNotification('প্রোফাইল আপডেট করতে ব্যর্থ: ডেটাবেজ ত্রুটি।', 'error');
            }
        };

        // ইউজার ডিটেইলস টগল করার ফাংশন (আপডেট করা হয়েছে: এখন সম্পূর্ণ ইউজার অবজেক্ট পাস করা হয়)
        window.toggleUserDetails = (userId) => {
            const detailRow = document.getElementById(`details-row-${userId}`);
            const user = allUsersData[userId];
            const icon = document.getElementById(`toggle-icon-${userId}`);
            
            if (!detailRow) return;

            if (detailRow.classList.contains('hidden')) {
                // ডেটা রেন্ডার এবং দেখানো
                if (user) {
                    // সম্পূর্ণ ইউজার অবজেক্ট generateProfileEditForm-এ পাঠানো হচ্ছে
                    const contentHtml = generateProfileEditForm(user);
                    detailRow.querySelector('.user-details-content').innerHTML = contentHtml;
                }
                detailRow.classList.remove('hidden');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                // লুকানো
                detailRow.classList.add('hidden');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        };

        // Function to render users table (UPDATED: মূল অ্যাকশন বাটন সরিয়ে শুধু টগল বাটন রাখা হয়েছে)
        const renderUsers = (users) => {
            usersTableBody.innerHTML = '';
            for (const userId in users) {
                const user = users[userId];
                
                if (userId === currentUserId && (user.role === 'admin' || user.role === 'moderator')) {
                    continue; 
                }
                
                const displayName = user.facebookName || 'N/A';
                const userEmail = user.email || 'N/A';
                const isSuspended = user.suspension?.suspended && user.suspension.suspendUntil > Date.now();
                
                const suspensionBadge = isSuspended 
                    ? `<span class="px-2 py-1 rounded-full text-xs font-semibold bg-red-500 text-white ml-2">সাসপেন্ড</span>`
                    : '';
                
                // প্রধান তথ্য রো
                const mainRow = document.createElement('tr');
                mainRow.id = `main-row-${userId}`;

                // Simplified mainRow actions: only the toggle button remains
                mainRow.innerHTML = `
                    <td class="text-sm text-gray-500 font-mono break-all">${userId.substring(0, 10)}...</td>
                    <td class="font-medium text-gray-800">${displayName} ${suspensionBadge}</td>
                    <td class="text-sm text-gray-600 break-all">${userEmail}</td>
                    <td class="font-semibold text-green-600">${(user.points || 0).toLocaleString('bn-BD')}</td>
                    <td>
                        <span class="px-2 py-1 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-700">
                            ${user.role || 'user'}
                        </span>
                    </td>
                    <td class="flex justify-end pr-4">
                        <!-- প্রোফাইল ড্রপডাউন টগল বাটন -->
                        <button class="px-3 py-1 rounded-full text-xs font-bold text-white transition-colors duration-200 brand-blue hover:bg-blue-700 flex items-center gap-1" onclick="toggleUserDetails('${userId}')" title="সম্পূর্ণ প্রোফাইল ডেটা ও অ্যাকশন">
                            <span class="hidden sm:inline">অ্যাকশন</span>
                            <i class="fas fa-chevron-down ml-1" id="toggle-icon-${userId}"></i>
                        </button>
                    </td>
                `;
                usersTableBody.appendChild(mainRow);
                
                // প্রোফাইল বিস্তারিত রো (ড্রপডাউন)
                const detailRow = document.createElement('tr');
                detailRow.id = `details-row-${userId}`;
                detailRow.classList.add('user-details-row', 'hidden');
                detailRow.innerHTML = `
                    <td colspan="6">
                        <div class="user-details-content">
                            <p class="text-gray-500">লোডিং প্রোফাইল ডেটা...</p>
                        </div>
                    </td>
                `;
                usersTableBody.appendChild(detailRow);
            }
        };


        // Function to render tasks table (UPDATED for Edit button)
        const renderTasks = (tasks) => {
            tasksTableBody.innerHTML = '';
            const sortedTasks = Object.keys(tasks).map(key => ({ id: key, ...tasks[key] })).sort((a, b) => b.createdAt - a.createdAt);

            sortedTasks.forEach((task) => {
                const row = document.createElement('tr');
                const taskStatus = task.status || 'N/A';
                let statusDisplay = 'N/A';
                let statusColor = 'text-gray-600';

                if (taskStatus === 'active') {
                    statusDisplay = 'সক্রিয়';
                    statusColor = 'text-green-600';
                } else if (taskStatus === 'completed') {
                    statusDisplay = 'সম্পূর্ণ';
                    statusColor = 'text-blue-600';
                } else if (taskStatus === 'closed') {
                    statusDisplay = 'বন্ধ';
                    statusColor = 'text-red-600';
                }

                // টাস্ক এডিট করার জন্য ডেটা প্রসেস করা (HTML এ পাস করার জন্য JSON স্ট্রিং)
                const taskForEdit = JSON.stringify({
                    id: task.id,
                    taskLink: task.taskLink,
                    taskType: task.taskType,
                    quantity: task.quantity,
                    // Check if pointsPerTask is explicitly set (not just default)
                    pointsPerTask: task.pointsPerTask
                }).replace(/"/g, '&quot;'); 

                row.innerHTML = `
                    <td class="text-sm text-gray-500 font-mono break-all">${task.id.substring(0, 10)}...</td>
                    <td class="font-medium">${task.taskType || 'N/A'}</td>
                    <td><a href="${task.taskLink}" target="_blank" class="brand-blue-text hover:underline">${task.taskLink ? task.taskLink.substring(0, 30) + '...' : 'N/A'}</a></td>
                    <td class="font-semibold text-yellow-600">${(task.pointsPerTask || 0).toLocaleString('bn-BD')}</td>
                    <td class="font-medium ${statusColor}">${statusDisplay}</td>
                    <td class="flex flex-wrap gap-2">
                        <!-- টাস্ক এডিট বাটন -->
                        <button class="px-4 py-2 rounded-full text-sm font-bold text-white transition-colors duration-200 bg-indigo-500 hover:bg-indigo-600" onclick='openTaskModal(${taskForEdit})'>
                            <i class="fas fa-edit mr-1"></i> এডিট
                        </button>
                        ${taskStatus === 'active' ? 
                            `<button class="px-4 py-2 rounded-full text-sm font-bold text-white transition-colors duration-200 bg-red-500 hover:bg-red-600" onclick="openAdminModal('closeTask', { taskId: '${task.id}' })">
                                <i class="fas fa-times-circle mr-1"></i> বন্ধ করুন
                            </button>`
                        : `<span class="text-gray-500 text-xs italic ml-2">${statusDisplay}</span>`}
                    </td>
                `;
                tasksTableBody.appendChild(row);
            });
        };

        // Function to render proofs (No change)
        const renderProofs = (tasks) => {
            proofsGrid.innerHTML = '';
            let proofsFound = false;
            
            const proofsToRender = [];

            for (const taskId in tasks) {
                const task = tasks[taskId];
                if (task.proofs) {
                    for (const proofId in task.proofs) {
                        const proof = task.proofs[proofId];
                        
                        if (proof.status === 'pending') {
                            proofsFound = true;
                            const userData = allUsersData[proof.userId] || {};
                            proofsToRender.push({ taskId, proofId, task, proof, userData });
                        }
                    }
                }
            }
            
            proofsToRender.forEach(({ taskId, proofId, task, proof, userData }) => {
                const userDisplayName = userData.facebookName || proof.facebookName || 'অজানা ব্যবহারকারী';
                const taskIconClass = getTaskTypeIcon(task.taskType);
                
                let proofDataHtml = '';
                if (proof.screenshotUrl) {
                    proofDataHtml = `
                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <span class="font-medium text-gray-700 block mb-2"><i class="fas fa-image text-green-500 mr-2"></i> স্ক্রিনশট প্রুফ:</span>
                            <img src="${proof.screenshotUrl}" alt="স্ক্রিনশট প্রুফ" 
                                 class="w-full h-auto max-h-48 object-contain rounded-lg border border-gray-200 cursor-pointer"
                                 onclick="window.open('${proof.screenshotUrl}', '_blank')" />
                        </div>`;
                } else if (proof.facebookLink) { 
                    proofDataHtml = `
                        <p class="text-sm">
                            <span class="font-medium text-gray-700">ফেসবুক লিংক (পুরোনো):</span> 
                            <a href="${proof.facebookLink}" target="_blank" class="brand-blue-text hover:underline break-all">${proof.facebookLink}</a>
                        </p>`;
                }
                
                const proofCard = `
                    <div class="app-card p-5">
                        <div class="flex items-center justify-between mb-4 pb-4 border-b">
                            <div class="flex items-center gap-3">
                                <i class="fas ${taskIconClass} text-2xl"></i>
                                <div>
                                    <h4 class="font-semibold text-gray-800">${userDisplayName}</h4>
                                    <p class="text-sm text-gray-500 font-mono break-all">
                                        ইউজার আইডি: ${proof.userId.substring(0, 10)}...
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-3 mb-6">
                            <p class="text-sm">
                                <span class="font-medium text-gray-700">টাস্ক প্রকার:</span> 
                                <span class="font-semibold text-gray-900">${task.taskType}</span>
                            </p>
                            <p class="text-sm">
                                <span class="font-medium text-gray-700">টাস্ক লিংক:</span> 
                                <a href="${task.taskLink}" target="_blank" class="brand-blue-text hover:underline break-all">${task.taskLink}</a>
                            </p>
                            <p class="text-sm">
                                <span class="font-medium text-gray-700">পয়েন্ট:</span> 
                                <span class="font-semibold text-green-600">+${(task.pointsPerTask).toLocaleString('bn-BD')}</span>
                            </p>
                            ${proofDataHtml} 
                        </div>
                        <div class="flex gap-4">
                            <button class="flex-1 brand-blue text-white py-2.5 rounded-lg font-bold hover:brightness-110 transition duration-200" onclick="openAdminModal('approveProof', { taskId: '${taskId}', proofId: '${proofId}', userId: '${proof.userId}', points: ${task.pointsPerTask} })">
                                <i class="fas fa-thumbs-up mr-2"></i> অনুমোদন
                            </button>
                            <button class="flex-1 bg-red-500 text-white py-2.5 rounded-lg font-bold hover:bg-red-600 transition duration-200" onclick="openAdminModal('rejectProof', { taskId: '${taskId}', proofId: '${proofId}', userId: '${proof.userId}' })">
                                <i class="fas fa-times-circle mr-2"></i> বাতিল
                            </button>
                        </div>
                    </div>
                `;
                proofsGrid.insertAdjacentHTML('beforeend', proofCard);
            });
            
            if (!proofsFound) {
                proofsGrid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500 text-lg">🎉 কোনো নতুন প্রুফ নেই।</div>';
            }
        };

        // Function to render reports (No change)
        const renderReports = (reports) => {
            reportsGrid.innerHTML = '';
            let reportsFound = false;
            
            const reportsToRender = Object.keys(reports)
                .map(key => ({ id: key, ...reports[key] }))
                .filter(report => report.status === 'pending')
                .sort((a, b) => a.submittedAt - b.submittedAt); 

            reportsToRender.forEach((report) => {
                reportsFound = true;
                const typeColor = getReportTypeColor(report.type);
                const typeDisplay = getReportTypeDisplay(report.type);
                
                const reportCard = `
                    <div class="report-card app-card p-5 ${report.type}">
                        <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-100">
                            <span class="px-3 py-1 text-xs font-bold rounded-full text-white ${typeColor}">
                                ${typeDisplay}
                            </span>
                            <span class="text-xs text-gray-500">${new Date(report.submittedAt).toLocaleDateString('bn-BD')}</span>
                        </div>
                        <h4 class="text-lg font-bold text-gray-800 mb-2">${report.title}</h4>
                        <p class="text-sm text-gray-600 mb-4">${report.details}</p>

                        <div class="space-y-1 text-sm text-gray-700 mb-4">
                            <p><strong>ইউজার:</strong> ${report.userName || 'N/A'}</p>
                            <p class="text-xs"><strong>ইউজার ID:</strong> ${report.userId.substring(0, 10)}...</p>
                            ${report.screenshotUrl ? 
                                `<a href="${report.screenshotUrl}" target="_blank" class="brand-blue-text hover:underline text-xs block mt-1">
                                    <i class="fas fa-image mr-1"></i> স্ক্রিনশট দেখুন
                                </a>`
                            : ''}
                        </div>
                        
                        <div class="flex gap-3">
                            <button class="flex-1 bg-green-500 text-white font-bold py-2.5 rounded-lg hover:bg-green-600 transition" 
                                onclick="openAdminModal('approveReport', { reportId: '${report.id}', userId: '${report.userId}', userName: '${report.userName || 'N/A'}', title: '${report.title}' })">
                                <i class="fas fa-check-circle mr-2"></i> অনুমোদন
                            </button>
                            <button class="flex-1 bg-red-500 text-white font-bold py-2.5 rounded-lg hover:bg-red-600 transition" 
                                onclick="openAdminModal('rejectReport', { reportId: '${report.id}' })">
                                <i class="fas fa-times-circle mr-2"></i> বাতিল
                            </button>
                        </div>
                    </div>
                `;
                reportsGrid.insertAdjacentHTML('beforeend', reportCard);
            });

            if (!reportsFound) {
                reportsGrid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500 text-lg">✅ কোনো নতুন রিপোর্ট নেই।</div>';
            }
        };
        
        /** অন্যান্য সহায়ক ফাংশন (No change) */
        const getTaskTypeIcon = (type) => {
            switch(type.toLowerCase()) {
                case 'react': return 'fa-thumbs-up text-blue-600';
                case 'comment': return 'fa-comment text-indigo-600';
                case 'share': return 'fa-share text-cyan-600';
                case 'follow': return 'fa-user-plus text-purple-600';
                case 'groupjoin': return 'fa-users text-teal-600'; 
                default: return 'fa-list-check text-gray-600';
            }
        };
        const getReportTypeColor = (type) => {
            switch(type.toLowerCase()) {
                case 'bug': return 'bg-red-500'; case 'suggestion': return 'bg-blue-500';
                case 'security': return 'bg-green-500'; default: return 'bg-gray-500';
            }
        };
        const getReportTypeDisplay = (type) => {
            switch(type.toLowerCase()) {
                case 'bug': return 'বাগ/ত্রুটি'; case 'suggestion': return 'পরামর্শ';
                case 'security': return 'নিরাপত্তা'; default: return 'অন্যান্য';
            }
        };


        // ম্যানুয়াল সাসপেনশন হ্যান্ডলার (No change)
        window.handleManualSuspension = async (uId, durationMinutes, reasonMessage) => {
            showNotification(`ইউজার ID ${uId.substring(0, 8)}... কে সাসপেন্ড করার প্রক্রিয়া চলছে...`, 'info', 3000);
            const suspendUntil = Date.now() + (durationMinutes * 60 * 1000); 
            try {
                const suspensionRef = ref(rtdb, `users/${uId}/suspension`);
                await set(suspensionRef, {
                    suspended: true, suspendUntil: suspendUntil, reason: reasonMessage,
                    issuedBy: currentUserId, issuedAt: Date.now()
                });
                showNotification(`সফল! ইউজারকে ${durationMinutes} মিনিটের জন্য সাসপেন্ড করা হয়েছে।`, 'success', 8000);
            } catch (error) {
                console.error("Error setting manual suspension data:", error);
                showNotification('ম্যানুয়াল সাসপেনশন ডেটাবেজে লিখতে সমস্যা হচ্ছে।', 'error');
            }
        };

        // পয়েন্ট অ্যাডজাস্টমেন্ট ফাংশন (No change)
        window.handlePointAdjustment = async (uId, uName, amount, reason) => {
            showNotification(`${uName} এর পয়েন্ট পরিবর্তনের প্রক্রিয়া চলছে...`, 'info', 3000);
            const userRef = ref(rtdb, `users/${uId}`);
            const logRef = ref(rtdb, `pointAdjustments/${uId}`); 
            
            try {
                const userUpdateResult = await runTransaction(userRef, (currentData) => {
                    if (currentData) { currentData.points = (currentData.points || 0) + amount; }
                    return currentData;
                });

                if (!userUpdateResult.committed) { throw new Error("User point update transaction failed."); }
                
                const logEntry = {
                    adjustedBy: currentUserId, adjustedAt: Date.now(), adjustmentAmount: amount,
                    reason: reason, newPoints: userUpdateResult.snapshot.val().points, userName: uName 
                };
                push(logRef, logEntry); 

                const actionText = amount > 0 ? 'যোগ' : 'বাদ';
                showNotification(`সফল! ${uName} এর অ্যাকাউন্ট থেকে ${(Math.abs(amount)).toLocaleString('bn-BD')} পয়েন্ট ${actionText} করা হয়েছে। বর্তমান পয়েন্ট: ${userUpdateResult.snapshot.val().points.toLocaleString('bn-BD')}`, 'success', 10000);

            } catch (error) {
                console.error("Error adjusting user points:", error);
                showNotification('পয়েন্ট অ্যাডজাস্ট করতে ব্যর্থ: ডেটাবেজ ত্রুটি।', 'error');
            }
        };


        // সাসপেনশন প্রত্যাহারের হ্যান্ডলার (No change)
        window.handleUnsuspendUser = async (uId) => {
            showNotification(`ইউজার ID ${uId.substring(0, 8)}... এর সাসপেনশন প্রত্যাহারের প্রক্রিয়া চলছে...`, 'info', 3000);
            try {
                const suspensionRef = ref(rtdb, `users/${uId}/suspension`);
                await update(suspensionRef, {
                    suspended: false, suspendUntil: 0, reason: null, 
                    revokedBy: currentUserId, revokedAt: Date.now() 
                });
                showNotification(`সফল! ইউজার ID ${uId.substring(0, 8)}... এর সাসপেনশন প্রত্যাহার করা হয়েছে।`, 'success', 8000);
            } catch (error) {
                console.error("Error revoking suspension data:", error);
                showNotification('সাসপেনশন প্রত্যাহারের ডেটাবেজে লিখতে সমস্যা হচ্ছে।', 'error');
            }
        };


        // অন্যান্য গ্লোবাল অ্যাকশন ফাংশন (No change)
        window.toggleVerification = (userId, isVerified) => {
            const userRef = ref(rtdb, `users/${userId}`);
            update(userRef, { isVerified: !isVerified })
                .then(() => {
                    // সফল হলে ইউজার ডিটেইলস ড্রপডাউন বন্ধ করা
                    toggleUserDetails(userId); 
                    showNotification('ব্যবহারকারীর ভেরিফিকেশন স্ট্যাটাস আপডেট করা হয়েছে।', 'info');
                })
                .catch(error => showNotification('ভেরিফিকেশন স্ট্যাটাস আপডেট করতে ব্যর্থ।', 'error'));
        };

        window.handleCloseTask = (taskId) => {
            showNotification("কাজটি বন্ধ করার প্রক্রিয়া চলছে...", 'info');
            const taskRef = ref(rtdb, `tasks/${taskId}`);
            update(taskRef, { status: 'closed' })
                .then(() => showNotification('কাজ স্থায়ীভাবে বন্ধ করা হয়েছে।', 'success'))
                .catch(error => showNotification('কাজ বন্ধ করতে ব্যর্থ।', 'error'));
        };
        
        window.handleApproveProof = async (taskId, proofId, userId, pointsToAdd) => {
            showNotification("অনুমোদন প্রক্রিয়া চলছে...", 'info');
            const APPROVE_trust_CHANGE = 5; 
            if (!currentUserId) { showNotification('ত্রুটি: এডমিন আইডি পাওয়া যায়নি।', 'error'); return; }
            const proofRef = ref(rtdb, `tasks/${taskId}/proofs/${proofId}`);
            const userRef = ref(rtdb, `users/${userId}`);
            const taskRef = ref(rtdb, `tasks/${taskId}`);
            
            try {
                const snapshot = await get(proofRef);
                const currentProof = snapshot.val();
                if (!currentProof || currentProof.status !== 'pending') { showNotification('এই প্রুফটি ইতিমধ্যেই প্রক্রিয়া করা হয়েছে।', 'error'); return; }

                await update(proofRef, { status: 'approved', reviewedBy: currentUserId, reviewedAt: Date.now() });
                
                const userUpdatePromise = runTransaction(userRef, (currentData) => {
                    if (currentData) {
                        const newPoints = (currentData.points || 0) + pointsToAdd;
                        const newTasksCompleted = (currentData.tasksCompleted || 0) + 1;
                        const newtrustScore = (currentData.trustScore || 0) + APPROVE_trust_CHANGE;
                        currentData.points = newPoints;
                        currentData.tasksCompleted = newTasksCompleted;
                        currentData.trustScore = Math.min(100, Math.max(0, newtrustScore)); 
                        currentData.completedTasks = currentData.completedTasks || {};
                        currentData.completedTasks[taskId] = 'approved'; 
                    }
                    return currentData;
                });
                
                const taskUpdatePromise = runTransaction(taskRef, (currentData) => {
                    if (currentData) {
                        currentData.completedCount = (currentData.completedCount || 0) + 1;
                        if (currentData.quantity && currentData.completedCount >= currentData.quantity) { currentData.status = 'completed'; }
                    }
                    return currentData;
                });

                const [userResult] = await Promise.all([userUpdatePromise, taskUpdatePromise]);
                
                if (userResult.committed) {
                    const finaltrustScore = userResult.snapshot.val().trustScore;
                    showNotification(`প্রুফ সফলভাবে অনুমোদিত হয়েছে (+${pointsToAdd} পয়েন্ট)। নতুন trustScore: ${finaltrustScore}`, 'success');
                } else { showNotification('পয়েন্ট এবং টাস্ক ডেটা আপডেট ব্যর্থ হয়েছে।', 'error'); }
            } catch (error) {
                console.error("Error approving proof:", error);
                showNotification(`প্রুফ অনুমোদন করতে ব্যর্থ: ${error.message || 'অজানা ত্রুটি'}।`, 'error');
            }
        };

        window.handleRejectProof = async (taskId, proofId, userId, rejectionReason) => {
            showNotification("বাতিল প্রক্রিয়া চলছে...", 'info');
            const REJECT_trust_CHANGE = -10; 
            if (!currentUserId) { showNotification('ত্রুটি: এডমিন আইডি পাওয়া যায়নি।', 'error'); return; }
            const proofRef = ref(rtdb, `tasks/${taskId}/proofs/${proofId}`);
            const userRef = ref(rtdb, `users/${userId}`);
            
            try {
                const snapshot = await get(proofRef);
                const currentProof = snapshot.val();
                if (!currentProof || currentProof.status !== 'pending') { showNotification('এই প্রুফটি ইতিমধ্যেই প্রক্রিয়া করা হয়েছে।', 'error'); return; }
                
                await update(proofRef, { 
                    status: 'rejected', reviewedBy: currentUserId, reviewedAt: Date.now(), rejectionReason: rejectionReason 
                });
                
                const userResult = await runTransaction(userRef, (currentData) => {
                    if (currentData) {
                        currentData.tasksRejected = (currentData.tasksRejected || 0) + 1;
                        currentData.completedTasks = currentData.completedTasks || {};
                        delete currentData.completedTasks[taskId]; 
                        
                        const newtrustScore = (currentData.trustScore || 0) + REJECT_trust_CHANGE;
                        currentData.trustScore = Math.min(100, Math.max(0, newtrustScore));
                        
                        const currentSuspensionUntil = currentData.suspension?.suspendUntil || 0;
                        let suspendMinutes = 0;
                        let reasonMessage = '';
                        
                        if (currentData.trustScore <= 40) { suspendMinutes = 24 * 60; reasonMessage = 'ট্রাস্ট স্কোর ৪০ বা তার নিচে: ১ দিনের জন্য সাসপেনশন।'; } 
                        else if (currentData.trustScore <= 50) { suspendMinutes = 3 * 60; reasonMessage = 'ট্রাস্ট স্কোর ৫০ বা তার নিচে: ৩ ঘন্টার জন্য সাসপেনশন।'; } 
                        else if (currentData.trustScore <= 60) { suspendMinutes = 60; reasonMessage = 'ট্রাস্ট স্কোর ৬০ বা তার নিচে: ১ ঘন্টার জন্য সাসপেনশন।'; } 
                        else if (currentData.trustScore <= 70) { suspendMinutes = 30; reasonMessage = 'ট্রাস্ট স্কোর ৭০ বা তার নিচে: ৩০ মিনিটের জন্য সাসপেনশন।'; }
                        
                        if (suspendMinutes > 0) {
                            const suspendUntil = Date.now() + (suspendMinutes * 60 * 1000);
                            if (suspendUntil > currentSuspensionUntil) {
                                currentData.suspension = {
                                    suspended: true, suspendUntil: suspendUntil, reason: reasonMessage,
                                    issuedBy: currentUserId, issuedAt: Date.now()
                                };
                            }
                        }
                    }
                    return currentData;
                });
                
                if (userResult.committed) {
                    const finalUserData = userResult.snapshot.val();
                    const finaltrustScore = finalUserData.trustScore;
                    let notificationMessage = `প্রুফ সফলভাবে বাতিল করা হয়েছে। নতুন trustScore: ${finaltrustScore}`;
                    if (finalUserData.suspension && finalUserData.suspension.suspended) { notificationMessage += ` **ইউজারকে সাসপেন্ড করা হয়েছে।**`; }
                    showNotification(notificationMessage, 'info');
                } else { showNotification('ব্যবহারকারীর ডেটা আপডেট ব্যর্থ হয়েছে।', 'error'); }
            } catch (error) {
                console.error("Error rejecting proof:", error);
                showNotification(`প্রুফ বাতিল করতে ব্যর্থ: ${error.message || 'অজানা ত্রুটি'}।`, 'error');
            }
        };

        window.handleApproveReport = async (reportId, userIdToReward, rewardPoints, reviewComment) => {
            showNotification(`রিপোর্ট ID ${reportId.substring(0, 8)}... এর জন্য পুরস্কার প্রক্রিয়া চলছে...`, 'info');
            const reportRef = ref(rtdb, `reports/${reportId}`);
            const userRef = ref(rtdb, `users/${userIdToReward}`);

            try {
                const userUpdateResult = await runTransaction(userRef, (currentData) => {
                    if (currentData) {
                        currentData.points = (currentData.points || 0) + rewardPoints;
                        currentData.reportsApproved = (currentData.reportsApproved || 0) + 1;
                    }
                    return currentData;
                });
                if (!userUpdateResult.committed) { throw new Error("User point update transaction failed."); }

                await update(reportRef, {
                    status: 'approved', rewardPoints: rewardPoints, reviewedBy: currentUserId,
                    reviewedAt: Date.now(), reviewComment: reviewComment 
                });
                showNotification(`সফল! ইউজারকে ${rewardPoints} পয়েন্ট দেওয়া হয়েছে এবং রিপোর্টটি আর্কাইভ করা হয়েছে।`, 'success');
            } catch (error) {
                console.error("Error rewarding report:", error);
                showNotification(`পুরস্কার দিতে ব্যর্থ: ${error.message || 'অজানা ত্রুটি'}।`, 'error');
            }
        };
        
        window.handleRejectReport = async (reportId, reviewComment) => {
            showNotification(`রিপোর্ট ID ${reportId.substring(0, 8)}... বাতিল করার প্রক্রিয়া চলছে...`, 'info');
            const reportRef = ref(rtdb, `reports/${reportId}`);
            try {
                await update(reportRef, {
                    status: 'rejected', reviewedBy: currentUserId, reviewedAt: Date.now(),
                    reviewComment: reviewComment, rewardPoints: 0 
                });
                showNotification(`সফল! রিপোর্ট ID ${reportId.substring(0, 8)}... বাতিল করা হয়েছে। বাতিলের কারণ রেকর্ড করা হয়েছে।`, 'success');
            } catch (error) {
                console.error("Error rejecting report:", error);
                showNotification(`রিপোর্ট বাতিল করতে ব্যর্থ: ${error.message || 'অজানা ত্রুটি'}।`, 'error');
            }
        };


        // Tab switching logic (No change)
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => {
                    t.classList.remove('bg-blue-600', 'text-white');
                    t.classList.add('bg-gray-200', 'text-gray-700');
                });
                tabContents.forEach(tc => tc.classList.add('hidden'));

                const tabName = tab.dataset.tab;
                document.getElementById(tabName).classList.remove('hidden');
                tab.classList.remove('bg-gray-200', 'text-gray-700');
                tab.classList.add('bg-blue-600', 'text-white');
                
                if (tabName === 'settings') {
                    loadControlSettings(); 
                }
            });
        });

        // ইভেন্ট লিসেনার সেট করা
        saveReferralSettingsBtn.addEventListener('click', handleSaveReferralSettings);
        saveProductPointsBtn.addEventListener('click', handleSaveProductPoints);

        // Expose global functions for button clicks
        window.openAdminModal = openAdminModal;
        window.handleApproveProof = handleApproveProof;
        window.handleRejectProof = handleRejectProof;
        window.handleApproveReport = handleApproveReport;
        window.handleRejectReport = handleRejectReport;
        window.handleUnsuspendUser = handleUnsuspendUser; 
        window.handlePointAdjustment = handlePointAdjustment; 
        window.handleProfileUpdate = handleProfileUpdate; 
        window.toggleUserDetails = toggleUserDetails;
    </script>
</body>
</html>

